# é¡¹ç›®å‹åŠ›é¢è¯•åº”å¯¹æŒ‡å—

## ğŸ“Œ å¿«é€Ÿç´¢å¼•
- [æ ¸å¿ƒåŸç†é€Ÿè®°](#æ ¸å¿ƒåŸç†é€Ÿè®°)
- [é«˜é¢‘å‹åŠ›é—®é¢˜](#é«˜é¢‘å‹åŠ›é—®é¢˜)
- [æŠ€æœ¯ç»†èŠ‚æ·±æŒ–](#æŠ€æœ¯ç»†èŠ‚æ·±æŒ–)
- [åº”ç­”æŠ€å·§](#åº”ç­”æŠ€å·§)

---

## ğŸ¯ æ ¸å¿ƒåŸç†é€Ÿè®°

### é¡¹ç›®ä¸€ï¼šé«˜å¹¶å‘æ–‡ä»¶æœåŠ¡ç³»ç»Ÿ

#### 1. å¼‚æ­¥æ—¥å¿—æ ¸å¿ƒåŸç†ï¼ˆå¿…é—®ï¼‰
**åŒç¼“å†²æœºåˆ¶**
```
å‰ç«¯çº¿ç¨‹ï¼ˆä¸šåŠ¡ï¼‰        åç«¯çº¿ç¨‹ï¼ˆI/Oï¼‰
    å†™å…¥ â†’ BufferA â†â†’  BufferB â†’ ç£ç›˜
              â†‘äº¤æ¢â†“
    æ¡ä»¶å˜é‡é€šçŸ¥ (pthread_cond_signal)
```

**ä¸ºä»€ä¹ˆå¿«ï¼Ÿ**
- ä¸šåŠ¡çº¿ç¨‹åªå†™å†…å­˜ï¼ˆçº³ç§’çº§ï¼‰ï¼Œä¸ç­‰ç£ç›˜I/Oï¼ˆæ¯«ç§’çº§ï¼‰
- åç«¯çº¿ç¨‹æ‰¹é‡å†™å…¥ï¼ˆå‡å°‘ç³»ç»Ÿè°ƒç”¨ï¼‰ï¼š128æ¡æ—¥å¿—ä¸€æ¬¡write() vs 128æ¬¡write()
- IOPSæå‡åŸç†ï¼šå‡å°‘fsyncæ¬¡æ•°ï¼Œä»æ¯æ¡æ—¥å¿—1æ¬¡ â†’ æ¯æ‰¹1æ¬¡

**é¢è¯•å›ç­”æ¨¡æ¿**ï¼š
> "é‡‡ç”¨åŒç¼“å†²+ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ï¼Œå‰ç«¯çº¿ç¨‹å†™å…¥ç¼“å†²Aåç«‹å³è¿”å›ï¼Œåç«¯çº¿ç¨‹å¼‚æ­¥åˆ·æ–°ç¼“å†²Båˆ°ç£ç›˜ã€‚å½“Aå†™æ»¡æˆ–è¶…æ—¶æ—¶äº¤æ¢ABæŒ‡é’ˆï¼Œé€šè¿‡æ¡ä»¶å˜é‡é€šçŸ¥åç«¯çº¿ç¨‹ã€‚å…³é”®ä¼˜åŒ–ç‚¹æ˜¯æ‰¹é‡å†™å…¥ï¼Œå°†128æ¡æ—¥å¿—åˆå¹¶æˆä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨ï¼Œå‡å°‘å†…æ ¸æ€åˆ‡æ¢å¼€é”€ã€‚"

#### 2. Reactoræ¨¡å‹ï¼ˆå¿…é—®ï¼‰
**æ¶æ„å›¾**ï¼š
```
Main Reactorï¼ˆç›‘å¬socketï¼‰
    â†“ accept
Sub Reactor 1 â† å®¢æˆ·ç«¯è¿æ¥1
    â†“ epoll_wait (ETæ¨¡å¼)
    â†’ è¯»äº‹ä»¶ â†’ ä¸šåŠ¡å¤„ç† â†’ å†™äº‹ä»¶
Sub Reactor 2 â† å®¢æˆ·ç«¯è¿æ¥2
...
```

**ET vs LTå¯¹æ¯”**ï¼š
| æ¨¡å¼ | è§¦å‘æ—¶æœº | ä¼˜ç¼ºç‚¹ |
|-----|---------|--------|
| LTï¼ˆæ°´å¹³è§¦å‘ï¼‰ | æ•°æ®æœªè¯»å®Œä¼šåå¤é€šçŸ¥ | ç®€å•ï¼Œä½†epoll_waité¢‘ç¹è¿”å›æµªè´¹CPU |
| ETï¼ˆè¾¹ç¼˜è§¦å‘ï¼‰ | ä»…åœ¨çŠ¶æ€æ”¹å˜æ—¶é€šçŸ¥ä¸€æ¬¡ | é«˜æ•ˆï¼Œéœ€whileå¾ªç¯è¯»åˆ°EAGAIN |

**é¢è¯•é™·é˜±**ï¼šä¸ºä»€ä¹ˆé€‰ETï¼Ÿ
> "ETæ¨¡å¼é¿å…é‡å¤è§¦å‘å‡å°‘ç³»ç»Ÿè°ƒç”¨ï¼Œæµ‹è¯•ä¸­epoll_waitæ¬¡æ•°ä»15ké™è‡³4.2kã€‚ä»£ä»·æ˜¯éœ€è¦whileå¾ªç¯è¯»å°½æ•°æ®ç›´åˆ°EAGAINï¼Œä½†é…åˆéé˜»å¡socketä¸ä¼šé˜»å¡ä¸šåŠ¡ã€‚"

#### 3. é›¶æ‹·è´sendfileåŸç†
**ä¼ ç»Ÿ4æ¬¡æ‹·è´**ï¼š
```
ç£ç›˜ â†’ å†…æ ¸ç¼“å†²åŒº â†’ ç”¨æˆ·ç¼“å†²åŒº â†’ socketç¼“å†²åŒº â†’ ç½‘å¡
     ï¼ˆDMAæ‹·è´ï¼‰  ï¼ˆCPUæ‹·è´ï¼‰   ï¼ˆCPUæ‹·è´ï¼‰    ï¼ˆDMAæ‹·è´ï¼‰
```

**sendfile 2æ¬¡æ‹·è´**ï¼š
```
ç£ç›˜ â†’ å†…æ ¸ç¼“å†²åŒº â†’ ç½‘å¡
     ï¼ˆDMAæ‹·è´ï¼‰    ï¼ˆDMAæ‹·è´ï¼‰
```

**å…³é”®ä»£ç **ï¼š
```cpp
ssize_t sendfile(int out_fd, int in_fd, off_t *offset, size_t count);
// ç›´æ¥åœ¨å†…æ ¸ç©ºé—´å®Œæˆæ•°æ®ä¼ è¾“ï¼Œä¸ç»è¿‡ç”¨æˆ·æ€
```

#### 4. LRU-Kç®—æ³•ï¼ˆä¸­é«˜çº§å¿…é—®ï¼‰
**LRU-Kï¼ˆK=2ï¼‰åŸç†**ï¼š
- è®°å½•æ¯ä¸ªæ•°æ®å—çš„æœ€è¿‘2æ¬¡è®¿é—®æ—¶é—´æˆ³
- æ·˜æ±°æ—¶é€‰æ‹©"å€’æ•°ç¬¬2æ¬¡è®¿é—®"æ—¶é—´æœ€æ—©çš„å—
- **ä¸ºä»€ä¹ˆæ¯”LRUå¥½**ï¼šæŠµæŠ—ç¼“å­˜æ±¡æŸ“ï¼ˆæ‰«æå¤§æ–‡ä»¶åªè®¿é—®1æ¬¡ä¸ä¼šé©±é€çƒ­æ•°æ®ï¼‰

**å®ç°å…³é”®**ï¼š
```cpp
struct CacheNode {
    int access_count;  // è®¿é—®æ¬¡æ•°
    deque<time_t> history;  // ä¿å­˜æœ€è¿‘Kæ¬¡æ—¶é—´æˆ³
};
// K=2æ—¶ï¼Œåªæœ‰è®¿é—®â‰¥2æ¬¡çš„æ•°æ®æ‰è¿›å…¥çƒ­æ•°æ®
```

**æ·±åº¦è¿½é—®ï¼šLRU-Kæ·˜æ±°ç­–ç•¥çš„å…·ä½“æ‰§è¡Œ**
```cpp
class LRUKCache {
    struct Node {
        string key;
        string value;
        deque<time_t> access_history;  // æœ€å¤šä¿å­˜Kä¸ªæ—¶é—´æˆ³
    };
    
    list<Node> cache_list;  // åŒå‘é“¾è¡¨
    unordered_map<string, list<Node>::iterator> cache_map;  // å¿«é€ŸæŸ¥æ‰¾
    
    void evict() {
        time_t oldest_kth_time = LLONG_MAX;
        auto evict_it = cache_list.end();
        
        for (auto it = cache_list.begin(); it != cache_list.end(); ++it) {
            if (it->access_history.size() < K) {
                // è®¿é—®æ¬¡æ•°ä¸è¶³Kæ¬¡ï¼Œä¼˜å…ˆæ·˜æ±°ï¼ˆæŒ‰é¦–æ¬¡è®¿é—®æ—¶é—´ï¼‰
                if (it->access_history[0] < oldest_kth_time) {
                    oldest_kth_time = it->access_history[0];
                    evict_it = it;
                }
            } else {
                // æ¯”è¾ƒå€’æ•°ç¬¬Kæ¬¡è®¿é—®æ—¶é—´
                time_t kth_time = it->access_history[it->access_history.size() - K];
                if (kth_time < oldest_kth_time) {
                    oldest_kth_time = kth_time;
                    evict_it = it;
                }
            }
        }
        
        cache_map.erase(evict_it->key);
        cache_list.erase(evict_it);
    }
};
```

**é¢è¯•è¿½é—®**ï¼š"ä¸ºä»€ä¹ˆMySQL InnoDBç”¨çš„æ˜¯LRUçš„å˜ç§è€Œä¸æ˜¯æ ‡å‡†LRU-Kï¼Ÿ"
> "InnoDBä½¿ç”¨æ”¹è¿›çš„LRUç®—æ³•ï¼šå°†é“¾è¡¨åˆ†ä¸ºyoungåŒºï¼ˆ5/8ï¼‰å’ŒoldåŒºï¼ˆ3/8ï¼‰ï¼Œæ–°è¯»å…¥çš„é¡µå…ˆè¿›å…¥oldåŒºå¤´éƒ¨ï¼Œ1ç§’åå†æ¬¡è®¿é—®æ‰ç§»å…¥youngåŒºã€‚è¿™ä¸ªè®¾è®¡ï¼š
> 1. æ¯”LRU-2æ›´çœå†…å­˜ï¼ˆä¸éœ€è¦ä¿å­˜2ä¸ªæ—¶é—´æˆ³ï¼‰
> 2. åŒæ ·èƒ½é˜²æ­¢å…¨è¡¨æ‰«ææ±¡æŸ“ï¼ˆæ‰«æçš„é¡µç•™åœ¨oldåŒºå¾ˆå¿«è¢«æ·˜æ±°ï¼‰
> 3. å®ç°æ›´ç®€å•ï¼ˆåªéœ€è¦é“¾è¡¨æ“ä½œï¼Œä¸éœ€è¦æ—¶é—´æˆ³æ¯”è¾ƒï¼‰"

#### 5. å¯¹è±¡æ± ä¸å†…å­˜ç®¡ç†ï¼ˆé«˜çº§ä¼˜åŒ–ï¼‰
**ä¸ºä»€ä¹ˆéœ€è¦å¯¹è±¡æ± ï¼Ÿ**
```
ä¼ ç»Ÿåˆ†é…æ–¹å¼é—®é¢˜ï¼š
æ¯æ¬¡è¯·æ±‚ â†’ new Buffer â†’ ä¸šåŠ¡å¤„ç† â†’ delete Buffer
           â†“
é¢‘ç¹çš„malloc/freeå¯¼è‡´ï¼š
1. å†…å­˜ç¢ç‰‡ï¼š8å­—èŠ‚å¯¹é½ï¼Œå°å¯¹è±¡æµªè´¹ç©ºé—´
2. åˆ†é…å»¶è¿Ÿï¼šglibc ptmalloc2éœ€è¦æŸ¥æ‰¾freelistï¼ˆO(N)ï¼‰
3. é”ç«äº‰ï¼šå¤šçº¿ç¨‹åŒæ—¶mallocéœ€è¦äº‰å¤ºå…¨å±€é”
```

**å¯¹è±¡æ± å®ç°**ï¼š
```cpp
template<typename T>
class ObjectPool {
    vector<unique_ptr<T>> pool;
    queue<T*> free_list;  // ç©ºé—²å¯¹è±¡é˜Ÿåˆ—
    mutex mtx;
    
public:
    T* acquire() {
        lock_guard<mutex> lock(mtx);
        if (free_list.empty()) {
            // é¢„åˆ†é…ä¸€æ‰¹å¯¹è±¡ï¼ˆå‡å°‘é”ç«äº‰ï¼‰
            for (int i = 0; i < 16; ++i) {
                pool.push_back(make_unique<T>());
                free_list.push(pool.back().get());
            }
        }
        T* obj = free_list.front();
        free_list.pop();
        return obj;
    }
    
    void release(T* obj) {
        obj->reset();  // é‡ç½®çŠ¶æ€
        lock_guard<mutex> lock(mtx);
        free_list.push(obj);
    }
};

// ä½¿ç”¨RAIIè‡ªåŠ¨å½’è¿˜
class BufferGuard {
    ObjectPool<Buffer>& pool;
    Buffer* buf;
public:
    BufferGuard(ObjectPool<Buffer>& p) : pool(p), buf(pool.acquire()) {}
    ~BufferGuard() { pool.release(buf); }
    Buffer* get() { return buf; }
};
```

**jemalloc vs ptmalloc2 å¯¹æ¯”**ï¼š
| ç‰¹æ€§ | ptmalloc2 (glibc) | jemalloc (Facebook) |
|-----|------------------|-------------------|
| çº¿ç¨‹ç¼“å­˜ | æ—  | æœ‰ï¼ˆthread cacheé¿å…é”ï¼‰ |
| ç¢ç‰‡ç‡ | é«˜ï¼ˆ15-20%ï¼‰ | ä½ï¼ˆ5-10%ï¼‰ |
| å¤§å¯¹è±¡ä¼˜åŒ– | mmap | ç‹¬ç«‹arenaç®¡ç† |
| é€‚ç”¨åœºæ™¯ | é€šç”¨ | é«˜å¹¶å‘æœåŠ¡å™¨ |

**æ€§èƒ½æµ‹è¯•æ•°æ®**ï¼š
```bash
# 128çº¿ç¨‹å¹¶å‘åˆ†é…10ä¸‡æ¬¡
ptmalloc2: 1.2s, å†…å­˜å³°å€¼: 450MB
jemalloc:  0.8s, å†…å­˜å³°å€¼: 380MB (å‡å°‘15%)
```

---

### é¡¹ç›®äºŒï¼šåˆ†å¸ƒå¼KVå­˜å‚¨ï¼ˆRaftï¼‰

#### 1. Raftä¸‰å¤§æ ¸å¿ƒæœºåˆ¶ï¼ˆå¿…é—®ï¼‰

**1.1 é¢†å¯¼è€…é€‰ä¸¾**
```
Followerï¼ˆå¿ƒè·³è¶…æ—¶150-300msï¼‰
    â†’ Candidateï¼ˆTerm+1ï¼Œå‘é€RequestVote RPCï¼‰
        â†’ è·å¾—å¤šæ•°ç¥¨ â†’ Leader
        â†’ é‡åˆ°æ›´é«˜Term â†’ é€€å›Follower
```

**å…³é”®ç»†èŠ‚**ï¼š
- ä¸ºä»€ä¹ˆéšæœºè¶…æ—¶ï¼Ÿé¿å…é€‰ç¥¨åˆ†è£‚ï¼ˆæ‰€æœ‰èŠ‚ç‚¹åŒæ—¶å‘èµ·é€‰ä¸¾ï¼‰
- å¤šæ•°ç¥¨å…¬å¼ï¼šâŒˆN/2âŒ‰+1ï¼ˆ5èŠ‚ç‚¹éœ€è¦3ç¥¨ï¼‰
- **é¢è¯•é™·é˜±**ï¼š2èŠ‚ç‚¹é›†ç¾¤å¯ç”¨å—ï¼Ÿç­”ï¼šä¸å¯ç”¨ï¼Œ1ä¸ªèŠ‚ç‚¹æ•…éšœåæ— æ³•è¾¾æˆå¤šæ•°

**1.2 æ—¥å¿—å¤åˆ¶æµç¨‹**
```
å®¢æˆ·ç«¯ â†’ Leader.append(entry) â†’ æœ¬åœ°æ—¥å¿—
                 â†“ å¹¶è¡Œå‘é€ AppendEntries RPC
         Follower1ã€Follower2ã€Follower3
                 â†“ å¤šæ•°èŠ‚ç‚¹è¿”å›success
         Leader.commitIndex++ â†’ applyåˆ°çŠ¶æ€æœº â†’ è¿”å›å®¢æˆ·ç«¯
```

**å…³é”®æ¦‚å¿µ**ï¼š
- `commitIndex`ï¼šå·²æäº¤æ—¥å¿—çš„æœ€å¤§ç´¢å¼•ï¼ˆå¤šæ•°èŠ‚ç‚¹æŒä¹…åŒ–ï¼‰
- `lastApplied`ï¼šå·²åº”ç”¨åˆ°çŠ¶æ€æœºçš„ç´¢å¼•
- æµæ°´çº¿ä¼˜åŒ–ï¼šä¸ç­‰ä¸Šä¸€æ‰¹è¿”å›å°±å‘ä¸‹ä¸€æ‰¹ï¼ˆç±»ä¼¼TCPæ»‘åŠ¨çª—å£ï¼‰

**1.3 å®‰å…¨æ€§ä¿è¯**
| å±æ€§ | å«ä¹‰ | å¦‚ä½•ä¿è¯ |
|-----|------|---------|
| Log Matching | ç›¸åŒindex+termçš„æ—¥å¿—å†…å®¹ç›¸åŒ | Leaderåœ¨AppendEntriesä¸­æºå¸¦prevLogIndexå’ŒprevLogTermæ ¡éªŒ |
| Leader Completeness | å·²æäº¤æ—¥å¿—ä¸ä¼šè¢«è¦†ç›– | é€‰ä¸¾æ—¶åªæŠ•ç¥¨ç»™æ—¥å¿—"æ›´æ–°"çš„Candidateï¼ˆæ¯”è¾ƒlastTermå’ŒlastIndexï¼‰ |
| State Machine Safety | ä¸åŒèŠ‚ç‚¹ç›¸åŒindexæ‰§è¡Œç›¸åŒå‘½ä»¤ | å¼ºåˆ¶æ—¥å¿—å¤åˆ¶ï¼ŒFollowerè¦†ç›–ä¸ä¸€è‡´æ—¥å¿— |

#### 2. è·³è¡¨vsçº¢é»‘æ ‘vs B+æ ‘ï¼ˆå¯¹æ¯”é¢˜ï¼‰

| æ•°æ®ç»“æ„ | æŸ¥è¯¢æ—¶é—´ | æ’å…¥/åˆ é™¤ | å¹¶å‘å‹å¥½æ€§ | ç¼“å­˜å±€éƒ¨æ€§ |
|---------|---------|----------|-----------|-----------|
| è·³è¡¨ | O(logN) | O(logN) | â˜…â˜…â˜…â˜…â˜… æ— é” | è¾ƒå·®ï¼ˆæŒ‡é’ˆè·³è·ƒï¼‰ |
| çº¢é»‘æ ‘ | O(logN) | O(logN) | â˜…â˜…â˜†â˜†â˜† æ—‹è½¬éœ€å…¨å±€é” | è¾ƒå·® |
| B+æ ‘ | O(logN) | O(logN) | â˜…â˜…â˜…â˜†â˜† | â˜…â˜…â˜…â˜…â˜… é¡ºåºè®¿é—® |

**ä¸ºä»€ä¹ˆé€‰è·³è¡¨ï¼Ÿ**
> "å®ç°ç®€å•ï¼ˆ200è¡Œ vs çº¢é»‘æ ‘800è¡Œï¼‰ï¼Œæ”¯æŒæ— é”å¹¶å‘è¯»ï¼ˆCASæ›´æ–°æŒ‡é’ˆï¼‰ï¼Œæ’å…¥/åˆ é™¤ä¸éœ€è¦å…¨å±€é‡å¹³è¡¡ã€‚è™½ç„¶ç¼“å­˜å±€éƒ¨æ€§ä¸å¦‚B+æ ‘ï¼Œä½†å†…å­˜æ•°æ®åº“åœºæ™¯ä¸‹å†…å­˜è®¿é—®å·²ç»è¶³å¤Ÿå¿«ã€‚"

#### 3. WALæ—¥å¿—å…³é”®ç»†èŠ‚

**å†™å…¥æµç¨‹**ï¼š
```cpp
// 1. å…ˆå†™WALï¼ˆä¿è¯æŒä¹…æ€§ï¼‰
wal_append(log_entry);
fsync(wal_fd);  // å¼ºåˆ¶åˆ·ç›˜

// 2. å†ä¿®æ”¹å†…å­˜çŠ¶æ€æœº
skiplist.insert(key, value);
```

**ä¸ºä»€ä¹ˆéœ€è¦fsyncï¼Ÿ**
- Linuxå†™æ–‡ä»¶é»˜è®¤è¿›å…¥é¡µç¼“å­˜ï¼ˆPage Cacheï¼‰ï¼Œæ–­ç”µä¼šä¸¢å¤±
- fsyncå¼ºåˆ¶åˆ·æ–°åˆ°ç£ç›˜ï¼ˆ4mså»¶è¿Ÿï¼Œä½†ä¿è¯æŒä¹…æ€§ï¼‰

**Snapshotä¼˜åŒ–**ï¼š
```
[Snapshot-10000] + [Log 10001~10128]
                        â†‘ åªä¿ç•™æœ€è¿‘æ—¥å¿—
å®šæœŸå‹ç¼©ï¼šåˆ é™¤10000ä¹‹å‰çš„æ—¥å¿—ï¼Œå‡å°‘æ¢å¤æ—¶é—´
```

#### 4. çº¿æ€§ä¸€è‡´æ€§å®ç°

**å¹‚ç­‰æ€§ä¿è¯**ï¼š
```cpp
struct Request {
    uint64_t client_id;   // å®¢æˆ·ç«¯å”¯ä¸€ID
    uint64_t seq_num;     // é€’å¢åºåˆ—å·
};
// Leaderç»´æŠ¤: map<client_id, last_seq> 
// é‡å¤è¯·æ±‚ç›´æ¥è¿”å›ç¼“å­˜ç»“æœï¼Œä¸é‡å¤æ‰§è¡Œ
```

**Jepsenæµ‹è¯•åŸç†**ï¼š
- æ³¨å…¥æ•…éšœï¼šéšæœºæ€è¿›ç¨‹ã€ç½‘ç»œåˆ†åŒºã€æ—¶é’Ÿåç§»
- éªŒè¯ä¸€è‡´æ€§ï¼šè®°å½•æ‰€æœ‰æ“ä½œå†å²ï¼Œæ£€æŸ¥æ˜¯å¦å­˜åœ¨è¿åé¡ºåºçš„è¯»å†™

#### 5. æ—¥å¿—å‹ç¼©ä¸Snapshotï¼ˆç”Ÿäº§å¿…å¤‡ï¼‰

**ä¸ºä»€ä¹ˆéœ€è¦Snapshotï¼Ÿ**
```
é—®é¢˜ï¼šæ—¥å¿—æ— é™å¢é•¿
- å¯åŠ¨æ¢å¤æ…¢ï¼šéœ€è¦é‡æ”¾100ä¸‡æ¡æ—¥å¿—ï¼ˆè€—æ—¶10+åˆ†é’Ÿï¼‰
- ç£ç›˜å ç”¨é«˜ï¼šå•ä¸ªèŠ‚ç‚¹æ—¥å¿—æ–‡ä»¶è¾¾åˆ°10GB
- å†…å­˜å‹åŠ›å¤§ï¼šæ‰€æœ‰æ—¥å¿—é¡¹éƒ½åœ¨å†…å­˜ä¸­

è§£å†³ï¼šå®šæœŸç”Ÿæˆå¿«ç…§
```

**Snapshotå®ç°æµç¨‹**ï¼š
```cpp
// 1. ç”Ÿæˆå¿«ç…§ï¼ˆåå°çº¿ç¨‹å¼‚æ­¥æ‰§è¡Œï¼‰
void create_snapshot() {
    // è·å–å½“å‰çŠ¶æ€æœºå¿«ç…§
    string snapshot_data = state_machine->serialize();
    uint64_t last_included_index = commit_index;
    uint64_t last_included_term = log[commit_index].term;
    
    // å†™å…¥ç£ç›˜
    snapshot_file.write(last_included_index);
    snapshot_file.write(last_included_term);
    snapshot_file.write(snapshot_data);
    snapshot_file.sync();
    
    // 2. æˆªæ–­æ—¥å¿—ï¼ˆä¿ç•™æœ€è¿‘10kæ¡ç”¨äºåŒæ­¥æ…¢èŠ‚ç‚¹ï¼‰
    log.erase(log.begin(), log.begin() + last_included_index - 10000);
}

// 3. å®‰è£…å¿«ç…§ï¼ˆFollowerè½åå¤ªå¤šæ—¶ï¼‰
void install_snapshot(Snapshot snap) {
    // æ¸…ç©ºå½“å‰çŠ¶æ€æœº
    state_machine->clear();
    
    // åŠ è½½å¿«ç…§æ•°æ®
    state_machine->deserialize(snap.data);
    
    // æ›´æ–°å…ƒæ•°æ®
    last_applied = snap.last_included_index;
    commit_index = snap.last_included_index;
    
    // æˆªæ–­æ—¥å¿—
    log.clear();
}
```

**Snapshotè§¦å‘ç­–ç•¥**ï¼š
```
è§¦å‘æ¡ä»¶ï¼ˆæ»¡è¶³ä»»ä¸€ï¼‰ï¼š
1. æ—¥å¿—å¤§å°è¶…è¿‡é˜ˆå€¼ï¼ˆå¦‚100MBï¼‰
2. æ—¥å¿—æ¡ç›®æ•°è¶…è¿‡é˜ˆå€¼ï¼ˆå¦‚10ä¸‡æ¡ï¼‰
3. å®šæ—¶è§¦å‘ï¼ˆå¦‚æ¯å°æ—¶ï¼‰

ä¼˜åŒ–ï¼šå¢é‡å¿«ç…§
- ä½¿ç”¨RocksDBçš„checkpointåŠŸèƒ½
- åªä¿å­˜å¢é‡å˜åŒ–ï¼Œå‡å°‘I/Oå¼€é”€
```

**é¢è¯•è¿½é—®**ï¼š"Snapshotè¿‡ç¨‹ä¸­å¦‚ä½•å¤„ç†æ–°çš„å†™è¯·æ±‚ï¼Ÿ"
> "é‡‡ç”¨Copy-on-Writeç­–ç•¥ï¼š
> 1. Snapshotçº¿ç¨‹è¯»å–çŠ¶æ€æœºå½“å‰ç‰ˆæœ¬ï¼ˆç‰ˆæœ¬å·V1ï¼‰
> 2. æ–°å†™è¯·æ±‚ç”Ÿæˆæ–°ç‰ˆæœ¬ï¼ˆV2ï¼‰ï¼Œä¸å½±å“V1
> 3. Snapshotå®Œæˆåï¼ŒV1å¯ä»¥è¢«GCå›æ”¶
> 
> ç±»ä¼¼äºMySQLçš„MVCCæœºåˆ¶ï¼Œä¸åŒç‰ˆæœ¬å…±å­˜ï¼Œé¿å…é˜»å¡å†™å…¥ã€‚"

#### 6. Raftæ€§èƒ½ä¼˜åŒ–é«˜çº§æŠ€å·§

**6.1 æ‰¹é‡å¤åˆ¶ï¼ˆBatchingï¼‰**
```cpp
// å·®ï¼šæ¯ä¸ªè¯·æ±‚å•ç‹¬å¤åˆ¶
client.put("key1", "val1") â†’ å¤åˆ¶1æ¡æ—¥å¿— â†’ è¿”å›
client.put("key2", "val2") â†’ å¤åˆ¶1æ¡æ—¥å¿— â†’ è¿”å›

// å¥½ï¼šæ‰¹é‡å¤åˆ¶
vector<LogEntry> batch;
for (int i = 0; i < 100; ++i) {
    batch.push_back({key, value});
}
// ä¸€æ¬¡å¤åˆ¶100æ¡æ—¥å¿—ï¼Œå»¶è¿Ÿä»100msé™è‡³5ms
```

**6.2 Pipelineå¤åˆ¶ï¼ˆç±»ä¼¼TCPæ»‘åŠ¨çª—å£ï¼‰**
```cpp
// ä¸ç­‰ä¸Šä¸€æ‰¹AppendEntriesè¿”å›ï¼Œç«‹å³å‘é€ä¸‹ä¸€æ‰¹
class LogReplicator {
    uint64_t next_index[MAX_PEERS];  // æ¯ä¸ªFollowerçš„ä¸‹ä¸€æ¡æ—¥å¿—ä½ç½®
    uint64_t match_index[MAX_PEERS]; // å·²åŒ¹é…çš„æ—¥å¿—ä½ç½®
    
    void replicate() {
        for (auto peer : followers) {
            // å‘é€ [next_index, next_index + batch_size)
            send_append_entries(peer, next_index[peer], batch_size);
            next_index[peer] += batch_size;  // ä¹è§‚åœ°å‰ç§»ï¼ˆå‡è®¾ä¼šæˆåŠŸï¼‰
        }
    }
    
    void on_append_reply(peer, success, match_index) {
        if (success) {
            this->match_index[peer] = match_index;
            update_commit_index();  // æ£€æŸ¥æ˜¯å¦æœ‰æ–°æ—¥å¿—å¯ä»¥æäº¤
        } else {
            // å›é€€é‡è¯•
            next_index[peer] = match_index + 1;
            resend(peer);
        }
    }
};
```

**6.3 Read Indexä¼˜åŒ–ï¼ˆè¯»ä¸èµ°æ—¥å¿—ï¼‰**
```
ä¼ ç»Ÿè¯»æµç¨‹ï¼ˆå¼ºä¸€è‡´ä½†æ…¢ï¼‰ï¼š
å®¢æˆ·ç«¯è¯»è¯·æ±‚ â†’ Leaderå†™å…¥no-opæ—¥å¿— â†’ å¤åˆ¶åˆ°å¤šæ•°èŠ‚ç‚¹ â†’ è¿”å›ç»“æœ
                                    â†“
                              å»¶è¿Ÿï¼š1ä¸ªRTT

Read Indexä¼˜åŒ–ï¼š
å®¢æˆ·ç«¯è¯»è¯·æ±‚ â†’ Leaderè®°å½•å½“å‰commitIndex â†’ å‘å¿ƒè·³ç¡®è®¤Leaderèº«ä»½ â†’ è¿”å›ç»“æœ
                                                  â†“
                                         å»¶è¿Ÿï¼šåŠä¸ªRTTï¼ˆå¿ƒè·³ï¼‰
```

**å®ç°ä»£ç **ï¼š
```cpp
void handle_read(Key key) {
    // 1. è®°å½•å½“å‰commitIndex
    uint64_t read_index = commit_index;
    
    // 2. å‘é€å¿ƒè·³ç¡®è®¤è‡ªå·±ä»æ˜¯Leaderï¼ˆé˜²æ­¢ç½‘ç»œåˆ†åŒºï¼‰
    if (broadcast_heartbeat_and_wait_majority()) {
        // 3. ç­‰å¾…çŠ¶æ€æœºåº”ç”¨åˆ°read_index
        while (last_applied < read_index) {
            this_thread::sleep_for(1ms);
        }
        
        // 4. è¯»å–çŠ¶æ€æœºè¿”å›ç»“æœ
        return state_machine->get(key);
    } else {
        return Error("Not leader");
    }
}
```

**æ€§èƒ½æå‡**ï¼š
- è¯»QPSä»6kæå‡è‡³20kï¼ˆå‡å°‘æ—¥å¿—å¤åˆ¶å¼€é”€ï¼‰
- P99å»¶è¿Ÿä»10msé™è‡³3ms

---

## ğŸ”¥ é«˜é¢‘å‹åŠ›é—®é¢˜ï¼ˆå‡†å¤‡æ ¸å¿ƒç­”æ¡ˆï¼‰

### é€šç”¨å‹åŠ›é—®é¢˜

#### Q1: "ä½ è¿™ä¸ªé¡¹ç›®ä¸å°±æ˜¯è·Ÿç€æ•™ç¨‹åšçš„å—ï¼Ÿ"
**åº”å¯¹ç­–ç•¥**ï¼š
1. **æ‰¿è®¤å‚è€ƒæ¥æº**ï¼š"ç¡®å®å‚è€ƒäº†é™ˆç¡•çš„ã€ŠLinuxå¤šçº¿ç¨‹æœåŠ¡ç«¯ç¼–ç¨‹ã€‹å’ŒMIT 6.824è¯¾ç¨‹"
2. **å¼ºè°ƒåˆ›æ–°ç‚¹**ï¼š"ä½†å®ç°äº†åŸç‰ˆæ²¡æœ‰çš„åŠŸèƒ½ï¼š
   - å¼‚æ­¥æ—¥å¿—å¢åŠ äº†æ»šåŠ¨å‹ç¼©ï¼ˆåŸç‰ˆæ²¡æœ‰ï¼‰
   - Raftå¢åŠ äº†SnapshotæŒä¹…åŒ–ï¼ˆè¯¾ç¨‹åªè¦æ±‚æ—¥å¿—å¤åˆ¶ï¼‰
   - è‡ªå·±è®¾è®¡äº†æ€§èƒ½æµ‹è¯•æ¡†æ¶ï¼ˆwrk + è‡ªå®šä¹‰Luaè„šæœ¬ï¼‰"
3. **å±•ç°æ·±åº¦ç†è§£**ï¼š"é‡åˆ°Xé—®é¢˜æ—¶ï¼Œé€šè¿‡é˜…è¯»libeventæºç å‘ç°Yï¼Œæœ€ç»ˆç”¨Zæ–¹æ³•è§£å†³"

#### Q2: "ä½ çš„QPSæ‰8.5kï¼ŒNginxèƒ½åˆ°10ä¸‡ï¼Œå·®è·åœ¨å“ªï¼Ÿ"
**æ­£ç¡®å›ç­”**ï¼š
```
å·®è·ä¸»è¦åœ¨3ä¸ªæ–¹é¢ï¼š
1. ä¸šåŠ¡å¤æ‚åº¦ï¼šæˆ‘çš„ç³»ç»ŸåŒ…å«æ–‡ä»¶å­˜å‚¨+å…ƒæ•°æ®ç®¡ç†+æ—¥å¿—ï¼ŒNginxåªåšHTTPè½¬å‘
2. ç¡¬ä»¶èµ„æºï¼š2æ ¸4G vs Nginxæµ‹è¯•ç¯å¢ƒé€šå¸¸16æ ¸32G
3. ä¼˜åŒ–æ·±åº¦ï¼šNginxä½¿ç”¨å…±äº«å†…å­˜æ± ã€å¼‚æ­¥I/Oã€CPUäº²å’Œæ€§ç­‰é«˜çº§ä¼˜åŒ–

æ”¹è¿›æ–¹å‘ï¼š
- å¼•å…¥io_uringæ›¿ä»£epollï¼ˆå‡å°‘ç³»ç»Ÿè°ƒç”¨ï¼‰
- å®ç°CPUäº²å’Œæ€§ç»‘å®šï¼ˆå‡å°‘ç¼“å­˜å¤±æ•ˆï¼‰
- ä¼˜åŒ–å†…å­˜åˆ†é…ï¼ˆé¢„åˆ†é…+æ— é”é˜Ÿåˆ—ï¼‰
```

#### Q3: "å¦‚æœè®©ä½ é‡æ–°è®¾è®¡ï¼Œä½ ä¼šæ€ä¹ˆæ”¹ï¼Ÿ"
**å±•ç°æ¶æ„æ€ç»´**ï¼š
1. **å­˜å‚¨å±‚**ï¼šå¼•å…¥RocksDBæ›¿ä»£è·³è¡¨ï¼ˆæ›´æˆç†Ÿçš„LSMå¼•æ“ï¼‰
2. **ç½‘ç»œå±‚**ï¼šè€ƒè™‘RDMAé›¶æ‹·è´ï¼ˆé€‚åˆå†…ç½‘é«˜é€Ÿä¼ è¾“ï¼‰
3. **ä¸€è‡´æ€§**ï¼šå®ç°Raftçš„Read Indexä¼˜åŒ–ï¼ˆè¯»è¯·æ±‚ä¸èµ°æ—¥å¿—ï¼Œé™ä½å»¶è¿Ÿï¼‰
4. **ç›‘æ§**ï¼šé›†æˆPrometheusæš´éœ²æŒ‡æ ‡ï¼ˆQPSã€å»¶è¿Ÿåˆ†ä½æ•°ã€é”™è¯¯ç‡ï¼‰

---

### æ–‡ä»¶æœåŠ¡ç³»ç»Ÿä¸“é¡¹é—®é¢˜

#### Q4: "åŒç¼“å†²å¦‚æœå‰ç«¯çº¿ç¨‹å†™å…¥è¿‡å¿«ï¼Œç¼“å†²åŒºæ»¡äº†æ€ä¹ˆåŠï¼Ÿ"
**æ ‡å‡†ç­”æ¡ˆ**ï¼š
```cpp
// å®ç°æµæ§æœºåˆ¶
if (buffer_A.size() > MAX_SIZE) {
    // æ–¹æ¡ˆ1ï¼šé˜»å¡ç­‰å¾…ï¼ˆä¿è¯æ—¥å¿—ä¸ä¸¢ï¼‰
    cond_wait(buffer_not_full);
    
    // æ–¹æ¡ˆ2ï¼šä¸¢å¼ƒæ—¥å¿—ï¼ˆå…è®¸ä¸¢å¤±DEBUGçº§åˆ«ï¼‰
    if (level == DEBUG) return;
    
    // æ–¹æ¡ˆ3ï¼šè§¦å‘ç´§æ€¥åˆ·æ–°ï¼ˆé€šçŸ¥åç«¯çº¿ç¨‹ç«‹å³äº¤æ¢ï¼‰
    urgent_swap = true;
}
```
**æˆ‘çš„é€‰æ‹©**ï¼š"é‡‡ç”¨æ–¹æ¡ˆ1+3ç»„åˆï¼ŒERROR/FATALçº§åˆ«é˜»å¡ç­‰å¾…ï¼ŒDEBUGçº§åˆ«è§¦å‘ç´§æ€¥åˆ·æ–°åç»§ç»­å†™å…¥ã€‚æµ‹è¯•ä¸­99%çš„æƒ…å†µä¸ä¼šè§¦å‘ã€‚"

#### Q5: "ETæ¨¡å¼ä¸‹å¦‚ä½•å¤„ç†å¤§æ–‡ä»¶ä¸Šä¼ ï¼Ÿ"
**é™·é˜±**ï¼šä¸€æ¬¡è¯»ä¸å®Œä¼šä¸¢æ•°æ®
```cpp
// æ­£ç¡®åšæ³•ï¼šå¾ªç¯è¯»å–ç›´åˆ°EAGAIN
while (true) {
    ssize_t n = read(fd, buffer, SIZE);
    if (n > 0) {
        process(buffer, n);
    } else if (n == -1 && errno == EAGAIN) {
        break;  // æ•°æ®è¯»å®Œï¼Œç­‰å¾…ä¸‹æ¬¡é€šçŸ¥
    } else if (n == 0) {
        // å¯¹ç«¯å…³é—­è¿æ¥
        close_connection();
    }
}
```

#### Q6: "LRU-Kçš„Kå€¼æ€ä¹ˆé€‰æ‹©ï¼ŸK=3ä¸æ˜¯æ›´å¥½å—ï¼Ÿ"
**æƒè¡¡åˆ†æ**ï¼š
| Kå€¼ | å†…å­˜å¼€é”€ | å‘½ä¸­ç‡ | é€‚ç”¨åœºæ™¯ |
|----|---------|--------|---------|
| K=1ï¼ˆLRUï¼‰ | ä½ | åŸºå‡† | è®¿é—®æ¨¡å¼è§„å¾‹ |
| K=2 | ä¸­ | +15% | æœ‰å°‘é‡æ‰«æ |
| K=3 | é«˜ | +3%ï¼ˆé€’å‡ï¼‰ | é¢‘ç¹æ‰«æ |

**æˆ‘çš„é€‰æ‹©**ï¼š"K=2æ˜¯å·¥ä¸šç•Œç»éªŒå€¼ï¼ˆMySQLä¹Ÿç”¨K=2ï¼‰ï¼Œåœ¨æˆ‘çš„åœºæ™¯ä¸‹æµ‹è¯•K=3æ”¶ç›Šä¸è¶³1%ï¼Œä½†æ¯ä¸ªèŠ‚ç‚¹å¤šå­˜å‚¨1ä¸ªæ—¶é—´æˆ³ï¼ˆ8å­—èŠ‚Ã—1000ä¸‡=76MBï¼‰ï¼Œä¸å€¼å¾—ã€‚"

#### Q7: "epollä¸ºä»€ä¹ˆæ¯”select/pollå¿«ï¼Ÿåº•å±‚åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ"
**ç³»ç»Ÿè°ƒç”¨å¯¹æ¯”**ï¼š
```cpp
// selectï¼šæ¯æ¬¡è°ƒç”¨éœ€è¦æ‹·è´æ•´ä¸ªfd_setåˆ°å†…æ ¸
int select(int nfds, fd_set *readfds, fd_set *writefds, ...);
// é—®é¢˜ï¼š
// 1. fd_setæœ‰å¤§å°é™åˆ¶ï¼ˆ1024ï¼‰
// 2. æ¯æ¬¡è°ƒç”¨éƒ½è¦éå†æ‰€æœ‰fdæ£€æŸ¥çŠ¶æ€ï¼ˆO(N)ï¼‰
// 3. ç”¨æˆ·æ€/å†…æ ¸æ€é¢‘ç¹æ‹·è´fdé›†åˆ

// epollï¼šäº‹ä»¶é©±åŠ¨ï¼Œåªè¿”å›å°±ç»ªçš„fd
int epoll_create(int size);  // åˆ›å»ºepollå®ä¾‹ï¼ˆçº¢é»‘æ ‘ï¼‰
int epoll_ctl(int epfd, int op, int fd, struct epoll_event *event);  // æ·»åŠ fd
int epoll_wait(int epfd, struct epoll_event *events, int maxevents, int timeout);
// ä¼˜åŠ¿ï¼š
// 1. æ— fdæ•°é‡é™åˆ¶ï¼ˆåªå—å†…å­˜é™åˆ¶ï¼‰
// 2. åªè¿”å›å°±ç»ªçš„fdï¼ˆO(1)è·å–ï¼‰
// 3. ä½¿ç”¨mmapå…±äº«å†…å­˜ï¼Œå‡å°‘æ‹·è´
```

**epollå†…æ ¸æ•°æ®ç»“æ„**ï¼š
```
epoll_create â†’ åˆ›å»º eventpoll å¯¹è±¡
                    â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚     çº¢é»‘æ ‘ï¼ˆå­˜å‚¨æ‰€æœ‰ç›‘å¬çš„fdï¼‰    â”‚  â† epoll_ctlæ·»åŠ 
    â”‚     rb_root rbr;                â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚     å°±ç»ªé“¾è¡¨ï¼ˆå­˜å‚¨å°±ç»ªçš„fdï¼‰      â”‚  â† epoll_waitè¯»å–
    â”‚     list_head rdllist;          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å½“fdå°±ç»ªæ—¶ï¼š
ç¡¬ä»¶ä¸­æ–­ â†’ å†…æ ¸å›è°ƒ ep_poll_callback() â†’ å°†fdåŠ å…¥rdllist
```

**ä¸ºä»€ä¹ˆå¿«ï¼Ÿ**
1. **çº¢é»‘æ ‘ç®¡ç†fd**ï¼šæ·»åŠ /åˆ é™¤O(logN)ï¼Œé«˜æ•ˆç®¡ç†å¤§é‡è¿æ¥
2. **å°±ç»ªé“¾è¡¨**ï¼šåªè¿”å›å°±ç»ªfdï¼Œä¸éœ€è¦éå†å…¨éƒ¨
3. **å›è°ƒæœºåˆ¶**ï¼šfdå°±ç»ªæ—¶å†…æ ¸ä¸»åŠ¨é€šçŸ¥ï¼Œè€Œä¸æ˜¯è½®è¯¢

**æµ‹è¯•æ•°æ®**ï¼š
```
10000ä¸ªè¿æ¥ï¼Œ100ä¸ªæ´»è·ƒï¼š
select:  éå†10000æ¬¡ï¼Œè€—æ—¶ ~5ms
epoll:   åªå¤„ç†100ä¸ªï¼Œè€—æ—¶ ~0.1ms ï¼ˆå¿«50å€ï¼‰
```

#### Q8: "å¦‚æœæ–‡ä»¶ä¸Šä¼ åˆ°ä¸€åŠå®¢æˆ·ç«¯æ–­å¼€ï¼Œå¦‚ä½•å®ç°æ–­ç‚¹ç»­ä¼ ï¼Ÿ"
**å®ç°æ–¹æ¡ˆ**ï¼š
```cpp
// 1. æ–‡ä»¶åˆ†å—ä¸Šä¼ ï¼ˆæ¯å—1MBï¼‰
struct UploadSession {
    string file_id;           // æ–‡ä»¶å”¯ä¸€æ ‡è¯†ï¼ˆMD5ï¼‰
    uint64_t total_size;      // æ–‡ä»¶æ€»å¤§å°
    vector<bool> chunk_status; // æ¯å—æ˜¯å¦å·²ä¸Šä¼ 
    time_t last_update;       // æœ€åæ›´æ–°æ—¶é—´
};

// 2. æœåŠ¡ç«¯è®°å½•ä¸Šä¼ è¿›åº¦
map<string, UploadSession> upload_sessions;

// 3. å®¢æˆ·ç«¯ä¸Šä¼ åè®®
POST /upload/init
{
    "file_id": "md5_hash",
    "file_size": 104857600,
    "chunk_size": 1048576
}
// è¿”å›ï¼š{"session_id": "xxx", "uploaded_chunks": [0, 1, 5]}

// 4. ä¸Šä¼ åˆ†å—
POST /upload/chunk
{
    "session_id": "xxx",
    "chunk_index": 2,
    "data": "base64_encoded_data"
}

// 5. æ–­å¼€é‡è¿åæ¢å¤
GET /upload/status?session_id=xxx
// è¿”å›ï¼š{"uploaded_chunks": [0,1,2,5], "missing": [3,4,6,7,...]}

// 6. å®Œæˆä¸Šä¼ 
POST /upload/finish?session_id=xxx
// æœåŠ¡ç«¯åˆå¹¶æ‰€æœ‰chunk â†’ éªŒè¯MD5 â†’ è¿”å›æˆåŠŸ
```

**å…³é”®å®ç°ç»†èŠ‚**ï¼š
```cpp
// åˆ†å—å…ƒæ•°æ®æŒä¹…åŒ–ï¼ˆé˜²æ­¢æœåŠ¡ç«¯é‡å¯ä¸¢å¤±è¿›åº¦ï¼‰
void persist_session(const UploadSession& session) {
    // å†™å…¥Redisæˆ–RocksDB
    redis->setex(session.file_id, 3600, serialize(session));
}

// æ¸…ç†è¿‡æœŸä¼šè¯ï¼ˆé˜²æ­¢å†…å­˜æ³„æ¼ï¼‰
void cleanup_expired_sessions() {
    auto now = time(nullptr);
    for (auto it = upload_sessions.begin(); it != upload_sessions.end();) {
        if (now - it->second.last_update > 3600) {  // 1å°æ—¶æœªæ´»è·ƒ
            delete_partial_file(it->second.file_id);
            it = upload_sessions.erase(it);
        } else {
            ++it;
        }
    }
}
```

**ä¼˜åŒ–ç‚¹**ï¼š
- ä½¿ç”¨Rangeè¯·æ±‚å¤´å®ç°HTTPæ ‡å‡†æ–­ç‚¹ç»­ä¼ ï¼š`Range: bytes=1048576-2097151`
- åˆ†å—å¹¶è¡Œä¸Šä¼ ï¼šå®¢æˆ·ç«¯å¼€8ä¸ªçº¿ç¨‹åŒæ—¶ä¸Šä¼ ä¸åŒchunk
- ç§’ä¼ åŠŸèƒ½ï¼šé€šè¿‡MD5æŸ¥é‡ï¼Œå·²å­˜åœ¨çš„æ–‡ä»¶ç›´æ¥è¿”å›æˆåŠŸ

---

### Raftç³»ç»Ÿä¸“é¡¹é—®é¢˜

#### Q7: "ç½‘ç»œåˆ†åŒºåå‡ºç°åŒä¸»æ€ä¹ˆåŠï¼Ÿ"
**Raftä¿è¯ä¸ä¼šå‡ºç°**ï¼š
```
åœºæ™¯ï¼š5èŠ‚ç‚¹é›†ç¾¤åˆ†è£‚ä¸º [A,B] å’Œ [C,D,E]

[A,B]åˆ†åŒºï¼ˆ2ç¥¨ï¼‰ï¼š
- Aå°è¯•å½“Leaderï¼Œä½†æ— æ³•è·å¾—3ç¥¨ï¼ˆå¤šæ•°ï¼‰ â†’ é€‰ä¸¾å¤±è´¥
- å®¢æˆ·ç«¯è¯·æ±‚å†™å…¥A â†’ Aæ‹’ç»ï¼ˆä¸æ˜¯Leaderï¼‰

[C,D,E]åˆ†åŒºï¼ˆ3ç¥¨ï¼‰ï¼š
- CæˆåŠŸå½“é€‰Leaderï¼ˆè·å¾—3ç¥¨ï¼‰ â†’ Term+1
- ç»§ç»­å¯¹å¤–æœåŠ¡

ç½‘ç»œæ¢å¤åï¼š
- Aæ”¶åˆ°Termæ›´é«˜çš„å¿ƒè·³ â†’ è‡ªåŠ¨é™çº§ä¸ºFollower
```

**å…³é”®**ï¼šTermå•è°ƒé€’å¢ + å¤šæ•°æ´¾æœºåˆ¶ â†’ ä¿è¯å”¯ä¸€Leader

#### Q8: "Leaderåˆšæäº¤æ—¥å¿—å°±å®•æœºï¼Œä¼šä¸¢æ•°æ®å—ï¼Ÿ"
**æ—¶åºåˆ†æ**ï¼š
```
T1: Leaderæäº¤index=100çš„æ—¥å¿—ï¼ˆå·²å¤åˆ¶åˆ°3ä¸ªèŠ‚ç‚¹ï¼‰
T2: Leaderè¿”å›å®¢æˆ·ç«¯"æˆåŠŸ" 
T3: Leaderå®•æœº
T4: æ–°Leaderé€‰ä¸¾ï¼ˆä¸€å®šåœ¨3ä¸ªå‰¯æœ¬èŠ‚ç‚¹ä¸­äº§ç”Ÿï¼‰
    â†“ æ–°Leaderæ—¥å¿—ä¸€å®šåŒ…å«index=100ï¼ˆé€‰ä¸¾é™åˆ¶ï¼‰
T5: æ–°Leaderç»§ç»­æœåŠ¡ â†’ æ•°æ®ä¸ä¸¢å¤±
```

**åä¾‹**ï¼ˆä¼šä¸¢å¤±çš„åœºæ™¯ï¼‰ï¼š
```
Leaderåˆšå†™å…¥æœ¬åœ°æ—¥å¿—ï¼Œè¿˜æœªå¤åˆ¶å°±å®•æœº
â†’ æ–°Leaderå¯èƒ½æ²¡æœ‰è¿™æ¡æ—¥å¿— â†’ å®¢æˆ·ç«¯æ”¶åˆ°è¶…æ—¶/å¤±è´¥
```
**ç»“è®º**ï¼šåªè¦å®¢æˆ·ç«¯æ”¶åˆ°"æˆåŠŸ"å“åº”ï¼Œæ•°æ®ä¸€å®šä¸ä¸¢ï¼ˆè¿™å°±æ˜¯å¼ºä¸€è‡´æ€§ï¼‰

#### Q9: "è·³è¡¨çš„å¹¶å‘è¯»å†™å¦‚ä½•å®ç°ï¼Ÿ"
**åˆ†å±‚åŠ é”**ï¼š
```cpp
class SkipList {
    mutex write_lock;  // å†™æ“ä½œå…¨å±€é”
    
    // è¯»æ“ä½œæ— é”ï¼ˆåˆ©ç”¨è·³è¡¨ç‰¹æ€§ï¼‰
    Node* find(Key key) {
        Node* cur = head;
        for (int level = MAX_LEVEL-1; level >= 0; --level) {
            while (cur->next[level] && cur->next[level]->key < key) {
                cur = cur->next[level];  // åªè¯»æŒ‡é’ˆï¼Œä¸ä¿®æ”¹
            }
        }
        return cur->next[0];
    }
    
    // å†™æ“ä½œéœ€è¦åŠ é”
    void insert(Key key, Value val) {
        lock_guard<mutex> lock(write_lock);
        // ... ä¿®æ”¹æŒ‡é’ˆ
    }
};
```

**é«˜çº§ä¼˜åŒ–**ï¼ˆå¯é€‰æåŠï¼‰ï¼š
- ä½¿ç”¨CASåŸå­æ“ä½œæ›¿ä»£é”ï¼š`atomic_compare_exchange(&node->next[level], expected, new_node)`
- ä½†å®ç°å¤æ‚åº¦é«˜ï¼ˆéœ€å¤„ç†ABAé—®é¢˜ï¼‰ï¼Œæˆ‘çš„ç‰ˆæœ¬é‡‡ç”¨ç®€å•çš„è¯»å†™é”

#### Q10: "Protobufç›¸æ¯”JSONçš„ä¼˜åŠ¿åœ¨å“ªï¼Ÿ"
| ç»´åº¦ | Protobuf | JSON |
|-----|----------|------|
| åºåˆ—åŒ–é€Ÿåº¦ | å¿«10å€ï¼ˆäºŒè¿›åˆ¶ç¼–ç ï¼‰ | æ…¢ï¼ˆå­—ç¬¦ä¸²è§£æï¼‰ |
| ä½“ç§¯ | å°3-10å€ï¼ˆå˜é•¿ç¼–ç ï¼‰ | å¤§ï¼ˆå†—ä½™å­—æ®µåï¼‰ |
| Schema | å¼ºç±»å‹ï¼ˆç¼–è¯‘æ—¶æ£€æŸ¥ï¼‰ | å¼±ç±»å‹ï¼ˆè¿è¡Œæ—¶é”™è¯¯ï¼‰ |
| å¯è¯»æ€§ | å·®ï¼ˆäºŒè¿›åˆ¶ï¼‰ | å¥½ï¼ˆæ–‡æœ¬ï¼‰ |

**Raftåœºæ™¯é€‰æ‹©Protobuf**ï¼š
- å†…ç½‘é€šä¿¡ä¸éœ€è¦äººç±»å¯è¯»
- RPCååæ•æ„Ÿï¼ˆèŠ‚ç‚¹é—´é¢‘ç¹é€šä¿¡ï¼‰
- å¼ºç±»å‹é¿å…æ•°æ®é”™è¯¯ï¼ˆTerm/Indexå¿…é¡»æ˜¯int64ï¼‰

**Protobufå˜é•¿ç¼–ç åŸç†**ï¼š
```
// Varintç¼–ç ç¤ºä¾‹
int32å€¼300ï¼š
- äºŒè¿›åˆ¶ï¼š0000 0001 0010 1100
- Varintï¼š10101100 00000010 ï¼ˆ2å­—èŠ‚ï¼Œæœ€é«˜ä½ä¸ºæ ‡å¿—ä½ï¼‰
- èŠ‚çœï¼š4å­—èŠ‚ â†’ 2å­—èŠ‚

int64å€¼1ï¼š
- Varintï¼š00000001 ï¼ˆ1å­—èŠ‚ï¼‰
- èŠ‚çœï¼š8å­—èŠ‚ â†’ 1å­—èŠ‚
```

#### Q11: "å¦‚æœRafté›†ç¾¤ä¸­æŸä¸ªèŠ‚ç‚¹ç£ç›˜æ»¡äº†æ€ä¹ˆåŠï¼Ÿ"
**é—®é¢˜åœºæ™¯**ï¼š
```
èŠ‚ç‚¹Aç£ç›˜æ»¡ â†’ æ— æ³•å†™å…¥æ–°æ—¥å¿— â†’ AppendEntrieså¤±è´¥
â†’ Leaderæ— æ³•è¾¾æˆå¤šæ•°æ´¾ â†’ æ•´ä¸ªé›†ç¾¤ä¸å¯ç”¨
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

**æ–¹æ¡ˆ1ï¼šæ—¥å¿—æˆªæ–­ä¸å¿«ç…§**
```cpp
// æ£€æµ‹ç£ç›˜ä½¿ç”¨ç‡
if (disk_usage() > 90%) {
    // ç«‹å³ç”Ÿæˆå¿«ç…§å¹¶åˆ é™¤æ—§æ—¥å¿—
    create_snapshot();
    truncate_log(last_snapshot_index);
}
```

**æ–¹æ¡ˆ2ï¼šä¼˜é›…é™çº§**
```cpp
// èŠ‚ç‚¹ä¸»åŠ¨é€€å‡ºé›†ç¾¤
void handle_disk_full() {
    // 1. é€šçŸ¥Leaderç§»é™¤è‡ªå·±
    send_remove_peer_request(leader_id, my_id);
    
    // 2. åœæ­¢æ¥æ”¶æ–°æ—¥å¿—
    state = READONLY;
    
    // 3. ç»§ç»­æä¾›è¯»æœåŠ¡ï¼ˆä½¿ç”¨æ—§æ•°æ®ï¼‰
    serve_read_only();
}
```

**æ–¹æ¡ˆ3ï¼šé…ç½®åŠ¨æ€è°ƒæ•´**
```
ç›‘æ§ç£ç›˜ â†’ è§¦å‘å‘Šè­¦ â†’ è‡ªåŠ¨æ‰©å®¹æˆ–æ¸…ç†
- è‡ªåŠ¨åˆ é™¤è¿‡æœŸå¿«ç…§ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰
- å‹ç¼©æ—¥å¿—æ–‡ä»¶ï¼ˆgzipå‹ç¼©ç‡å¯è¾¾70%ï¼‰
- è¿ç§»å†·æ•°æ®åˆ°å¯¹è±¡å­˜å‚¨ï¼ˆS3ï¼‰
```

**ç”Ÿäº§å®è·µ**ï¼ˆetcdçš„åšæ³•ï¼‰ï¼š
```
1. é™åˆ¶æ—¥å¿—å¤§å°ï¼šé»˜è®¤å•ä¸ªæ—¥å¿—æ–‡ä»¶100MB
2. é™åˆ¶å¿«ç…§æ•°é‡ï¼šä¿ç•™æœ€è¿‘5ä¸ªå¿«ç…§
3. é…é¢ç®¡ç†ï¼šè®¾ç½®æ€»å­˜å‚¨é…é¢ï¼ˆå¦‚2GBï¼‰ï¼Œè¶…è¿‡åæ‹’ç»å†™å…¥
4. ç¢ç‰‡æ•´ç†ï¼šå®šæœŸæ‰§è¡Œdefragå‹ç¼©ç£ç›˜ç©ºé—´
```

#### Q12: "Raftæ—¥å¿—å†²çªæ—¶å¦‚ä½•å¿«é€Ÿå›é€€ï¼Ÿ"
**é—®é¢˜**ï¼šä¼ ç»ŸRaftæ¯æ¬¡å›é€€1æ¡ï¼Œæœ€åO(N)æ¬¡RPC

**åœºæ™¯**ï¼š
```
Leaderæ—¥å¿—ï¼š[1,1,1,2,2,2,3,3,3]  (term, index)
Followeræ—¥å¿—ï¼š[1,1,1,4,4,4,4,4,4]
             â†‘ ä»index=4å¼€å§‹å†²çª

ä¼ ç»Ÿæ–¹æ³•ï¼š
Leaderå°è¯•åŒæ­¥index=9 â†’ å¤±è´¥ï¼Œnext_index--
Leaderå°è¯•åŒæ­¥index=8 â†’ å¤±è´¥ï¼Œnext_index--
...
éœ€è¦6æ¬¡RPCæ‰èƒ½æ‰¾åˆ°å†²çªç‚¹index=3
```

**ä¼˜åŒ–ï¼šæ‰¹é‡å›é€€ï¼ˆRaftè®ºæ–‡ä¼˜åŒ–ï¼‰**
```cpp
// AppendEntries RPCè¿”å›å†²çªä¿¡æ¯
struct AppendReply {
    bool success;
    uint64_t conflict_term;   // å†²çªæ—¥å¿—çš„term
    uint64_t conflict_index;  // è¯¥termçš„ç¬¬ä¸€æ¡æ—¥å¿—index
};

// Leaderæ”¶åˆ°å†²çªå“åº”å
void handle_conflict(peer_id, reply) {
    if (!reply.success) {
        // æŸ¥æ‰¾Leaderæ—¥å¿—ä¸­conflict_termçš„æœ€åä¸€æ¡
        uint64_t leader_last_index = find_last_index_of_term(reply.conflict_term);
        
        if (leader_last_index > 0) {
            // Leaderä¹Ÿæœ‰è¿™ä¸ªtermï¼Œå›é€€åˆ°è¯¥termæœ€åä¸€æ¡
            next_index[peer_id] = leader_last_index + 1;
        } else {
            // Leaderæ²¡æœ‰è¿™ä¸ªtermï¼Œå›é€€åˆ°Followerçš„conflict_index
            next_index[peer_id] = reply.conflict_index;
        }
        // ä¸€æ¬¡æ€§å›é€€åˆ°æ­£ç¡®ä½ç½®ï¼Œå‡å°‘RPCæ¬¡æ•°
    }
}
```

**ä¼˜åŒ–æ•ˆæœ**ï¼š
- åŸæœ¬6æ¬¡RPC â†’ 1æ¬¡RPC
- ç½‘ç»œåˆ†åŒºæ¢å¤æ—¶é—´ä»30sé™è‡³3s

#### Q13: "å¦‚æœå®ç°Raftæˆå‘˜å˜æ›´ï¼ˆæ·»åŠ /åˆ é™¤èŠ‚ç‚¹ï¼‰ï¼Ÿ"
**éš¾ç‚¹**ï¼šæˆå‘˜å˜æ›´è¿‡ç¨‹ä¸­å¯èƒ½å‡ºç°åŒä¸»

**é”™è¯¯ç¤ºä¾‹**ï¼ˆç›´æ¥å˜æ›´ï¼‰ï¼š
```
æ—§é…ç½®[A,B,C] â†’ æ–°é…ç½®[A,B,C,D,E]
             â†“
æŸä¸€æ—¶åˆ»ï¼š
- A,B,Cä½¿ç”¨æ—§é…ç½®ï¼ˆ3èŠ‚ç‚¹ï¼Œ2ç¥¨å³å¯å½“é€‰ï¼‰
- D,Eä½¿ç”¨æ–°é…ç½®ï¼ˆ5èŠ‚ç‚¹ï¼Œ3ç¥¨å³å¯å½“é€‰ï¼‰

å¯èƒ½åŒæ—¶å­˜åœ¨ï¼š
- Leader1ï¼ˆAå½“é€‰ï¼Œè·å¾—A,Bçš„2ç¥¨ï¼‰ â† åœ¨æ—§é…ç½®ä¸­åˆæ³•
- Leader2ï¼ˆDå½“é€‰ï¼Œè·å¾—C,D,Eçš„3ç¥¨ï¼‰â† åœ¨æ–°é…ç½®ä¸­åˆæ³•
â†’ åŒä¸»é—®é¢˜ï¼
```

**æ­£ç¡®æ–¹æ¡ˆï¼šè”åˆå…±è¯†ï¼ˆJoint Consensusï¼‰**
```
é˜¶æ®µ1ï¼šè¿›å…¥è”åˆé…ç½®C_old,new
- éœ€è¦åŒæ—¶åœ¨æ—§é…ç½®å’Œæ–°é…ç½®ä¸­è¾¾æˆå¤šæ•°
- Leaderå¿…é¡»è·å¾—ï¼šC_oldçš„å¤šæ•° AND C_newçš„å¤šæ•°

é˜¶æ®µ2ï¼šåˆ‡æ¢åˆ°æ–°é…ç½®C_new
- åªéœ€è¦åœ¨æ–°é…ç½®ä¸­è¾¾æˆå¤šæ•°

ç¤ºä¾‹ï¼š[A,B,C] â†’ [A,B,C,D,E]
T1: Leaderæäº¤C_old,newæ—¥å¿—
    éœ€è¦ï¼š(A,B,Cä¸­2ç¥¨) AND (A,B,C,D,Eä¸­3ç¥¨)
    â†’ æœ€å°‘éœ€è¦3ç¥¨ï¼ˆæ»¡è¶³ä¸¤ä¸ªå¤šæ•°æ´¾ï¼‰
    
T2: ç­‰å¾…C_old,newæäº¤åï¼ŒLeaderæäº¤C_newæ—¥å¿—
    éœ€è¦ï¼š(A,B,C,D,Eä¸­3ç¥¨)
    
T3: C_newæäº¤åï¼Œæˆå‘˜å˜æ›´å®Œæˆ
```

**å®ç°ä»£ç **ï¼š
```cpp
void add_peer(NodeId new_peer) {
    if (state != LEADER) return;
    
    // 1. åˆ›å»ºè”åˆé…ç½®
    Configuration joint_conf;
    joint_conf.old_peers = current_conf.peers;  // [A,B,C]
    joint_conf.new_peers = current_conf.peers + new_peer;  // [A,B,C,D]
    
    // 2. ä½œä¸ºæ—¥å¿—æ¡ç›®å¤åˆ¶
    log.append({term, CONFIG_CHANGE, joint_conf});
    replicate_to_majority();
    
    // 3. ç­‰å¾…è”åˆé…ç½®æäº¤
    wait_until_committed(joint_conf_index);
    
    // 4. åˆ‡æ¢åˆ°æ–°é…ç½®
    Configuration new_conf;
    new_conf.peers = joint_conf.new_peers;
    log.append({term, CONFIG_CHANGE, new_conf});
    replicate_to_majority();
}

// è®¡ç®—å¤šæ•°æ´¾
bool is_majority(set<NodeId> voters) {
    if (in_joint_consensus) {
        // è”åˆå…±è¯†ï¼šéœ€è¦åŒæ—¶æ»¡è¶³ä¸¤ä¸ªå¤šæ•°
        int old_votes = count_votes(old_peers, voters);
        int new_votes = count_votes(new_peers, voters);
        return (old_votes > old_peers.size()/2) && 
               (new_votes > new_peers.size()/2);
    } else {
        // æ™®é€šå¤šæ•°æ´¾
        return voters.size() > current_peers.size() / 2;
    }
}
```

**ç®€åŒ–æ–¹æ¡ˆï¼šå•èŠ‚ç‚¹å˜æ›´**ï¼ˆRaftä½œè€…æ¨èï¼‰
```
é™åˆ¶ï¼šæ¯æ¬¡åªæ·»åŠ æˆ–åˆ é™¤1ä¸ªèŠ‚ç‚¹
ä¼˜åŠ¿ï¼šæ— éœ€è”åˆå…±è¯†ï¼Œç›´æ¥åˆ‡æ¢é…ç½®

è¯æ˜å®‰å…¨æ€§ï¼š
æ—§é…ç½®[A,B,C]ï¼ˆ3èŠ‚ç‚¹ï¼Œéœ€è¦2ç¥¨ï¼‰
æ–°é…ç½®[A,B,C,D]ï¼ˆ4èŠ‚ç‚¹ï¼Œéœ€è¦3ç¥¨ï¼‰

ä»»æ„æ—¶åˆ»çš„å¤šæ•°æ´¾å¿…æœ‰äº¤é›†ï¼š
- æ—§é…ç½®ä»»æ„2èŠ‚ç‚¹ âˆ© æ–°é…ç½®ä»»æ„3èŠ‚ç‚¹ â‰  âˆ…
â†’ ä¸ä¼šå‡ºç°åŒä¸»

ä»£ç ç®€å•ï¼š
void add_peer_simple(NodeId peer) {
    current_peers.insert(peer);
    log.append({term, ADD_PEER, peer});
}
```

---

### å®æˆ˜åœºæ™¯ä¸è°ƒè¯•ç»éªŒ

#### Q14: "ç³»ç»Ÿä¸Šçº¿åå‘ç°å†…å­˜æ³„æ¼ï¼Œå¦‚ä½•æ’æŸ¥å’Œå®šä½ï¼Ÿ"
**æ’æŸ¥å·¥å…·é“¾**ï¼š

**1. ä½¿ç”¨Valgrindæ£€æµ‹**
```bash
# ç¼–è¯‘æ—¶åŠ è°ƒè¯•ç¬¦å·
g++ -g -O0 server.cpp -o server

# è¿è¡ŒValgrindï¼ˆæ…¢10-50å€ï¼Œä½†å‡†ç¡®ï¼‰
valgrind --leak-check=full --show-leak-kinds=all \
         --track-origins=yes --log-file=valgrind.log ./server

# åˆ†æç»“æœ
cat valgrind.log
# ==12345== LEAK SUMMARY:
# ==12345==    definitely lost: 40,000 bytes in 100 blocks
# ==12345==    at 0x4C2FB0F: malloc (in /usr/lib/valgrind/...)
# ==12345==    by Buffer::allocate() (buffer.cpp:45)
```

**2. Google Perftools heap profiler**
```cpp
// ä»£ç ä¸­å¯ç”¨heap profiler
#include <gperftools/heap-profiler.h>

int main() {
    HeapProfilerStart("heap_profile");
    
    run_server();  // è¿è¡Œä¸šåŠ¡ä»£ç 
    
    HeapProfilerDump("after_1hour");  // è®°å½•å †å¿«ç…§
    HeapProfilerStop();
}
```

```bash
# åˆ†æheap profile
pprof --text ./server heap_profile.0001.heap
# Total: 450.5 MB
# 280.3 MB (62.2%) @ Buffer::allocate
# 120.8 MB (26.8%) @ std::string::_M_create
#  49.4 MB (11.0%) @ Connection::new_request
```

**3. ç”Ÿäº§ç¯å¢ƒå¿«é€Ÿå®šä½**
```cpp
// è‡ªå®šä¹‰å†…å­˜ç»Ÿè®¡ï¼ˆä¾µå…¥å¼ä½†å¿«é€Ÿï¼‰
class MemoryTracker {
    static atomic<int64_t> total_allocated;
    static atomic<int64_t> total_freed;
    
public:
    static void* track_malloc(size_t size) {
        total_allocated += size;
        return malloc(size);
    }
    
    static void track_free(void* ptr, size_t size) {
        total_freed += size;
        free(ptr);
    }
    
    static int64_t get_leak_size() {
        return total_allocated - total_freed;
    }
};

// åœ¨å…³é”®è·¯å¾„åŸ‹ç‚¹
Buffer* buf = (Buffer*)MemoryTracker::track_malloc(sizeof(Buffer));
MemoryTracker::track_free(buf, sizeof(Buffer));

// å®šæœŸè¾“å‡ºå†…å­˜ç»Ÿè®¡
LOG_INFO("Memory leak: {} bytes", MemoryTracker::get_leak_size());
```

**å¸¸è§æ³„æ¼åŸå› ä¸ä¿®å¤**ï¼š
```cpp
// åŸå› 1ï¼šæ™ºèƒ½æŒ‡é’ˆå¾ªç¯å¼•ç”¨
class Node {
    shared_ptr<Node> next;  // âŒ å¾ªç¯é“¾è¡¨å¯¼è‡´å†…å­˜æ³„æ¼
};
// ä¿®å¤ï¼šä½¿ç”¨weak_ptræ‰“ç ´å¾ªç¯
class Node {
    weak_ptr<Node> next;  // âœ…
};

// åŸå› 2ï¼šå›è°ƒå‡½æ•°æ•è·thisæŒ‡é’ˆ
class Server {
    void register_callback() {
        timer.set_callback([this]() {  // âŒ å¦‚æœServerè¢«åˆ é™¤ï¼Œthisæ‚¬ç©º
            this->handle_timeout();
        });
    }
};
// ä¿®å¤ï¼šä½¿ç”¨weak_ptr
class Server : public enable_shared_from_this<Server> {
    void register_callback() {
        weak_ptr<Server> weak_this = shared_from_this();
        timer.set_callback([weak_this]() {  // âœ…
            if (auto self = weak_this.lock()) {
                self->handle_timeout();
            }
        });
    }
};

// åŸå› 3ï¼šæ‰‹åŠ¨ç®¡ç†å†…å­˜å¿˜è®°é‡Šæ”¾
char* buffer = new char[1024];
if (error) {
    return;  // âŒ æ³„æ¼
}
delete[] buffer;
// ä¿®å¤ï¼šRAIIè‡ªåŠ¨ç®¡ç†
unique_ptr<char[]> buffer(new char[1024]);  // âœ… è‡ªåŠ¨é‡Šæ”¾
```

#### Q15: "é«˜å¹¶å‘ä¸‹CPUé£™å‡100%ï¼Œå¦‚ä½•å¿«é€Ÿå®šä½çƒ­ç‚¹å‡½æ•°ï¼Ÿ"
**ç«ç„°å›¾åˆ†æ**ï¼š

```bash
# 1. é‡‡æ ·60ç§’CPUæ•°æ®
sudo perf record -F 99 -p $(pidof server) -g -- sleep 60

# 2. ç”Ÿæˆperf.dataï¼ˆåŒ…å«è°ƒç”¨æ ˆï¼‰
sudo perf script > out.perf

# 3. ç”Ÿæˆç«ç„°å›¾
git clone https://github.com/brendangregg/FlameGraph
./FlameGraph/stackcollapse-perf.pl out.perf | \
./FlameGraph/flamegraph.pl > flame.svg

# 4. æµè§ˆå™¨æ‰“å¼€flame.svgåˆ†æ
firefox flame.svg
```

**ç«ç„°å›¾è§£è¯»**ï¼š
```
Xè½´ï¼šæ ·æœ¬å æ¯”ï¼ˆå®½åº¦è¶Šå®½ï¼Œå ç”¨CPUè¶Šå¤šï¼‰
Yè½´ï¼šè°ƒç”¨æ ˆæ·±åº¦ï¼ˆä»ä¸‹å¾€ä¸Šæ˜¯è°ƒç”¨é“¾ï¼‰

æ¡ˆä¾‹1ï¼šå‘ç°stringæ‹·è´å ç”¨30%
main â†’ handle_request â†’ parse_json â†’ std::string::operator=
                                            â†‘ ç«ç„°æœ€å®½
ä¼˜åŒ–ï¼šä½¿ç”¨string_viewé¿å…æ‹·è´
```

**å®æ—¶å®šä½å·¥å…·**ï¼š
```bash
# 1. topæŸ¥çœ‹è¿›ç¨‹CPUå ç”¨
top -Hp $(pidof server)
# PID   USER      PR  NI    VIRT    RES  %CPU %MEM  TIME+    COMMAND
# 12346 root      20   0   450m    80m  95.3  2.0   0:45.23  server

# 2. pstackæŸ¥çœ‹çº¿ç¨‹è°ƒç”¨æ ˆ
sudo pstack 12346
# Thread 5 (Thread 0x7f123456):
# #0  0x00007f1234567890 in epoll_wait ()
# #1  0x00000000004a2b1c in EventLoop::loop() at event_loop.cpp:123
# #2  0x00000000004a3f45 in std::thread::_State_impl::_M_run()

# 3. straceæŸ¥çœ‹ç³»ç»Ÿè°ƒç”¨ï¼ˆæ‰¾åˆ°æ…¢çš„syscallï¼‰
sudo strace -c -p $(pidof server)
# % time     seconds  usecs/call     calls    errors syscall
# 45.32    0.123456          12     10234           epoll_wait
# 28.45    0.077654           8      9876           write
# 15.23    0.041567          15      2765        88 connect
```

**æ¡ˆä¾‹ï¼šå®šä½çƒ­ç‚¹å¹¶ä¼˜åŒ–**
```cpp
// ç«ç„°å›¾æ˜¾ç¤ºï¼šJSONåºåˆ—åŒ–å ç”¨40% CPU
// åŸå› ï¼šæ¯æ¬¡è¯·æ±‚éƒ½é‡æ–°åºåˆ—åŒ–ç›¸åŒæ•°æ®

// ä¼˜åŒ–å‰ï¼š
string handle_request() {
    json resp = {{"status", "ok"}, {"data", get_data()}};
    return resp.dump();  // æ¯æ¬¡éƒ½åºåˆ—åŒ–
}

// ä¼˜åŒ–åï¼šå¢åŠ ç¼“å­˜
class ResponseCache {
    unordered_map<string, pair<string, time_t>> cache;
    
    string get_or_compute(const string& key, function<string()> compute) {
        auto [resp, timestamp] = cache[key];
        if (time(nullptr) - timestamp < 60) {  // 1åˆ†é’Ÿæœ‰æ•ˆ
            return resp;
        }
        resp = compute();
        cache[key] = {resp, time(nullptr)};
        return resp;
    }
};

string handle_request() {
    return resp_cache.get_or_compute("common", []() {
        json resp = {{"status", "ok"}, {"data", get_data()}};
        return resp.dump();
    });
}
// CPUå ç”¨ä»40%é™è‡³5%
```

#### Q16: "ç³»ç»Ÿå¶ç°è¯·æ±‚è¶…æ—¶ï¼Œä½†QPSä¸é«˜ï¼Œå¦‚ä½•æ’æŸ¥ï¼Ÿ"
**å¯èƒ½åŸå› ä¸æ’æŸ¥**ï¼š

**1. GCæš‚åœï¼ˆå¦‚æœç”¨Go/Javaï¼‰/ å†…å­˜æ•´ç†**
```bash
# æ£€æŸ¥ç³»ç»Ÿæ—¥å¿—
dmesg | grep -i "out of memory"
# [1234567.890] Out of memory: Kill process 12345 (server)

# C++ä¹Ÿå¯èƒ½å› ä¸ºå†…å­˜ç¢ç‰‡å¯¼è‡´mallocæ…¢
# è§£å†³ï¼šä½¿ç”¨jemallocï¼Œå®šæœŸåšå†…å­˜æ•´ç†
```

**2. ç£ç›˜I/OæŠ–åŠ¨**
```bash
# ç›‘æ§ç£ç›˜awaitï¼ˆç­‰å¾…æ—¶é—´ï¼‰
iostat -x 1
# Device  r/s   w/s   rkB/s   wkB/s  await  %util
# sda     0.0   500   0.0     2000   2.5ms  45%   â† æ­£å¸¸
# sda     0.0   800   0.0     3200   850ms  100%  â† å¼‚å¸¸ï¼
```

**åŸå› **ï¼šæ—¥å¿—åˆ·æ–°fsyncé˜»å¡ä¸šåŠ¡
```cpp
// é—®é¢˜ä»£ç ï¼š
void handle_request() {
    process();
    logger->write(log_msg);  // å¯èƒ½è§¦å‘fsyncï¼ˆ50msï¼‰
    return response;  // å¯¼è‡´æ•´ä¸ªè¯·æ±‚è¶…æ—¶
}

// è§£å†³ï¼šç¡®ä¿å¼‚æ­¥æ—¥å¿—ä¸é˜»å¡
logger->async_write(log_msg);  // ç«‹å³è¿”å›
```

**3. é•¿å°¾è¯·æ±‚è¢«é˜»å¡**
```cpp
// ä½¿ç”¨åˆ†å¸ƒå¼è¿½è¸ªå®šä½
class RequestTracer {
    struct Span {
        string name;
        time_point start, end;
    };
    vector<Span> spans;
    
public:
    void trace(string name, function<void()> func) {
        auto start = steady_clock::now();
        func();
        auto end = steady_clock::now();
        spans.push_back({name, start, end});
    }
    
    void dump() {
        for (auto& span : spans) {
            auto duration = duration_cast<milliseconds>(span.end - span.start);
            LOG_INFO("{}: {}ms", span.name, duration.count());
        }
    }
};

// ä½¿ç”¨ç¤ºä¾‹
RequestTracer tracer;
tracer.trace("parse_request", [&]() { parse(); });
tracer.trace("query_db", [&]() { db.query(); });  // å‘ç°è¿™é‡Œæ…¢
tracer.trace("serialize", [&]() { serialize(); });
tracer.dump();
// Output:
// parse_request: 2ms
// query_db: 850ms  â† æ‰¾åˆ°ç“¶é¢ˆï¼
// serialize: 5ms
```

**4. é”ç«äº‰å¯¼è‡´å¶ç°è¶…æ—¶**
```cpp
// ä½¿ç”¨perfæŸ¥çœ‹é”ç«äº‰
sudo perf record -e syscalls:sys_enter_futex -ag -- sleep 10
sudo perf report
# å‘ç°æŸä¸ªmutexäº‰ç”¨ä¸¥é‡

// ä¼˜åŒ–æ–¹æ¡ˆï¼šç»†åŒ–é”ç²’åº¦
// ä¼˜åŒ–å‰ï¼šå…¨å±€é”
mutex global_lock;
void update(int id, string value) {
    lock_guard<mutex> lock(global_lock);  // é˜»å¡æ‰€æœ‰çº¿ç¨‹
    map[id] = value;
}

// ä¼˜åŒ–åï¼šåˆ†ç‰‡é”
array<mutex, 16> shard_locks;
void update(int id, string value) {
    int shard = id % 16;
    lock_guard<mutex> lock(shard_locks[shard]);  // åªé˜»å¡åŒshard
    map[id] = value;
}
```

---

## ğŸ¯ æŠ€æœ¯ç»†èŠ‚æ·±æŒ–ï¼ˆå‡†å¤‡ææ–™ï¼‰

### å…³é”®ä»£ç ç‰‡æ®µï¼ˆå¯èƒ½è¦æ±‚ç™½æ¿å®ç°ï¼‰

#### 1. åŒç¼“å†²äº¤æ¢é€»è¾‘
```cpp
class AsyncLogger {
    Buffer buffer_A, buffer_B;
    mutex mtx;
    condition_variable cond;
    
    // å‰ç«¯çº¿ç¨‹è°ƒç”¨
    void append(const string& msg) {
        lock_guard<mutex> lock(mtx);
        buffer_A.append(msg);
        if (buffer_A.size() > THRESHOLD) {
            cond.notify_one();  // é€šçŸ¥åç«¯åˆ·æ–°
        }
    }
    
    // åç«¯çº¿ç¨‹è¿è¡Œ
    void flush_thread() {
        while (running) {
            unique_lock<mutex> lock(mtx);
            // ç­‰å¾…ç¼“å†²åŒºæœ‰æ•°æ®æˆ–è¶…æ—¶ï¼ˆ4ç§’ï¼‰
            cond.wait_for(lock, 4s, [&]{ return buffer_A.size() > 0; });
            
            // äº¤æ¢ç¼“å†²åŒºï¼ˆæ ¸å¿ƒï¼‰
            buffer_A.swap(buffer_B);
            lock.unlock();
            
            // æ‰¹é‡å†™å…¥ç£ç›˜ï¼ˆä¸æŒæœ‰é”ï¼‰
            fwrite(buffer_B.data(), buffer_B.size(), fp);
            fflush(fp);
            buffer_B.clear();
        }
    }
};
```

**å…³é”®ç‚¹**ï¼š
- `swap`æ“ä½œåœ¨é”ä¿æŠ¤ä¸‹å®Œæˆï¼ˆçº³ç§’çº§ï¼‰
- ç£ç›˜I/Oåœ¨é”å¤–æ‰§è¡Œï¼ˆæ¯«ç§’çº§ï¼‰â†’ æœ€å°åŒ–é”ç«äº‰

#### 2. Rafté€‰ä¸¾è¶…æ—¶æ£€æµ‹
```cpp
void Raft::tick() {
    auto now = steady_clock::now();
    
    if (state == FOLLOWER || state == CANDIDATE) {
        auto elapsed = duration_cast<milliseconds>(now - last_heartbeat);
        int timeout = random(150, 300);  // éšæœºè¶…æ—¶
        
        if (elapsed.count() > timeout) {
            start_election();  // å‘èµ·é€‰ä¸¾
        }
    }
    
    if (state == LEADER) {
        auto elapsed = duration_cast<milliseconds>(now - last_broadcast);
        if (elapsed.count() > 50) {  // 50mså‘ä¸€æ¬¡å¿ƒè·³
            broadcast_heartbeat();
        }
    }
}
```

**é¢è¯•æé—®**ï¼š"å¿ƒè·³é—´éš”ä¸ºä»€ä¹ˆæ˜¯50msï¼Ÿ"
> "ç»éªŒå€¼ï¼šç¡®ä¿åœ¨150msè¶…æ—¶å‰å‘é€è‡³å°‘2æ¬¡å¿ƒè·³ï¼ˆå®¹å¿1æ¬¡ä¸¢åŒ…ï¼‰ã€‚è®¡ç®—ï¼š150ms / 3 = 50msã€‚"

#### 3. epoll ETæ¨¡å¼è¯»å–
```cpp
void handle_read(int fd) {
    while (true) {
        char buf[4096];
        ssize_t n = read(fd, buf, sizeof(buf));
        
        if (n > 0) {
            request_buffer.append(buf, n);
            // ç»§ç»­è¯»ï¼Œç›´åˆ°EAGAIN
        } else if (n == 0) {
            // å¯¹ç«¯å…³é—­
            close_connection(fd);
            return;
        } else {  // n == -1
            if (errno == EAGAIN || errno == EWOULDBLOCK) {
                // æ•°æ®è¯»å®Œï¼Œå¼€å§‹å¤„ç†è¯·æ±‚
                process_request(request_buffer);
                return;
            } else if (errno == EINTR) {
                continue;  // ä¿¡å·ä¸­æ–­ï¼Œé‡è¯•
            } else {
                // çœŸå®é”™è¯¯
                log_error("read error: ", strerror(errno));
                return;
            }
        }
    }
}
```

---

### æ€§èƒ½æµ‹è¯•æ–¹æ³•ï¼ˆè¯æ˜æ•°æ®çœŸå®æ€§ï¼‰

#### æ–‡ä»¶æœåŠ¡ç³»ç»Ÿæµ‹è¯•
```bash
# ä½¿ç”¨wrkå‹æµ‹å·¥å…·
wrk -t8 -c100 -d60s --latency http://localhost:8080/upload

# è‡ªå®šä¹‰Luaè„šæœ¬æ¨¡æ‹ŸçœŸå®åœºæ™¯
wrk -t8 -c500 -d60s -s mixed_workload.lua

# mixed_workload.lua
request = function()
    local files = {"1KB", "10KB", "100KB", "1MB"}
    local file = files[math.random(#files)]
    return wrk.format("POST", "/upload?size=" .. file)
end
```

**è®°å½•çš„æŒ‡æ ‡**ï¼š
```
Requests/sec:   8542.33     â† QPS
Latency Distribution:
  50%    2.13ms              â† P50
  75%    3.67ms              â† P75
  90%    4.82ms              â† P90
  99%    6.91ms              â† P99ï¼ˆå…³é”®æŒ‡æ ‡ï¼‰
```

#### Raftç³»ç»Ÿæµ‹è¯•
```bash
# å¯åŠ¨5èŠ‚ç‚¹é›†ç¾¤
./start_cluster.sh --nodes=5

# ä½¿ç”¨è‡ªå®šä¹‰å®¢æˆ·ç«¯å‹æµ‹
./bench_client --qps=10000 --duration=60s --keys=1000000

# æ³¨å…¥æ•…éšœï¼ˆJepsené£æ ¼ï¼‰
./chaos_test.sh --kill-random-node --interval=10s
```

**éªŒè¯ä¸€è‡´æ€§**ï¼š
```python
# æ¨¡æ‹ŸJepsenæµ‹è¯•
def test_linearizability():
    history = []
    # å¹¶å‘å†™å…¥ä¸åŒkey
    for i in range(1000):
        history.append(client.put(f"key{i}", i))
    
    # ä»ä¸åŒèŠ‚ç‚¹è¯»å–
    for i in range(1000):
        val = random_client.get(f"key{i}")
        assert val == i  # å¿…é¡»è¯»åˆ°æœ€æ–°å€¼
```

---

## ğŸ’¡ åº”ç­”æŠ€å·§

### STARæ³•åˆ™ï¼ˆç»“æ„åŒ–å›ç­”ï¼‰
```
Situationï¼ˆèƒŒæ™¯ï¼‰ï¼šé‡åˆ°ä»€ä¹ˆé—®é¢˜
Taskï¼ˆä»»åŠ¡ï¼‰ï¼šéœ€è¦è§£å†³ä»€ä¹ˆ
Actionï¼ˆè¡ŒåŠ¨ï¼‰ï¼šé‡‡å–äº†ä»€ä¹ˆæ–¹æ³•
Resultï¼ˆç»“æœï¼‰ï¼šè¾¾æˆäº†ä»€ä¹ˆæ•ˆæœ
```

**ç¤ºä¾‹**ï¼š
```
é¢è¯•å®˜ï¼š"ä½ çš„å¼‚æ­¥æ—¥å¿—æ€ä¹ˆä¿è¯ä¸ä¸¢æ•°æ®ï¼Ÿ"

ä½ çš„å›ç­”ï¼š
S: "æµ‹è¯•ä¸­å‘ç°é«˜å¹¶å‘ä¸‹å‰ç«¯çº¿ç¨‹å†™å…¥è¿‡å¿«ï¼Œç¼“å†²åŒºå¯èƒ½æº¢å‡ºå¯¼è‡´æ—¥å¿—ä¸¢å¤±"
T: "éœ€è¦åœ¨æ€§èƒ½å’Œå¯é æ€§ä¹‹é—´æƒè¡¡"
A: "å®ç°äº†åˆ†çº§æµæ§ç­–ç•¥ï¼šDEBUGçº§åˆ«è§¦å‘ç´§æ€¥åˆ·æ–°ï¼ŒERRORçº§åˆ«é˜»å¡ç­‰å¾…ã€‚
   åŒæ—¶åœ¨åç«¯çº¿ç¨‹å¢åŠ åŒç¼“å†²é¢„åˆ†é…ï¼Œå°†äº¤æ¢æ—¶é—´ä»8msé™è‡³200ns"
R: "128çº¿ç¨‹å¹¶å‘å†™å…¥60ç§’ï¼Œ0æ¡æ—¥å¿—ä¸¢å¤±ï¼Œååé‡æå‡42.6%"
```

### åº”å¯¹ä¸ä¼šçš„é—®é¢˜
**é”™è¯¯åšæ³•**ï¼š"è¿™ä¸ªæˆ‘ä¸çŸ¥é“" âŒ

**æ­£ç¡®åšæ³•**ï¼š
1. **æ‰¿è®¤ä¸è¶³**ï¼š"è¿™ä¸ªç‚¹æˆ‘è¿˜æ²¡æ·±å…¥ç ”ç©¶"
2. **å±•ç°æ€è·¯**ï¼š"ä½†æˆ‘è§‰å¾—å¯ä»¥ä»Xæ–¹å‘è€ƒè™‘ï¼Œå› ä¸ºY"
3. **è¡¨è¾¾å­¦ä¹ æ„æ„¿**ï¼š"æ‚¨èƒ½å±•å¼€è®²è®²å—ï¼Ÿè¿™å—æˆ‘å¾ˆæ„Ÿå…´è¶£"

**ç¤ºä¾‹**ï¼š
```
é¢è¯•å®˜ï¼š"å¦‚æœå®ç°è·¨æ•°æ®ä¸­å¿ƒçš„Raftä¼šé‡åˆ°ä»€ä¹ˆé—®é¢˜ï¼Ÿ"

ä½ ï¼š"è¿™ä¸ªæˆ‘æ²¡æœ‰å®é™…ç»éªŒï¼Œä½†æˆ‘åˆ†æå¯èƒ½æœ‰å‡ ä¸ªæŒ‘æˆ˜ï¼š
1. ç½‘ç»œå»¶è¿Ÿï¼šè·¨æœºæˆ¿RTTä»1mså˜æˆ50msï¼Œå¿ƒè·³è¶…æ—¶éœ€è¦è°ƒå¤§
2. è„‘è£‚é£é™©ï¼šç½‘ç»œåˆ†åŒºæ¦‚ç‡å¢åŠ ï¼Œå¯èƒ½éœ€è¦å¼•å…¥ä»²è£èŠ‚ç‚¹
3. å¸¦å®½æˆæœ¬ï¼šæ—¥å¿—å¤åˆ¶æµé‡å¢åŠ ï¼Œå¯èƒ½éœ€è¦å‹ç¼©ä¼˜åŒ–
ä¸çŸ¥é“å®é™…ç”Ÿäº§ä¸­æ˜¯æ€ä¹ˆå¤„ç†çš„ï¼Ÿ"
```

---

## ğŸ“š å¯èƒ½è¢«é—®åˆ°çš„å»¶ä¼¸çŸ¥è¯†

### 1. å…¶ä»–å…±è¯†ç®—æ³•å¯¹æ¯”
| ç®—æ³• | å¤æ‚åº¦ | æ€§èƒ½ | ä¸€è‡´æ€§ | å…¸å‹åº”ç”¨ |
|-----|-------|------|--------|---------|
| Paxos | éš¾ç†è§£ | ä¸­ | å¼ºä¸€è‡´ | Chubbyï¼ˆGoogleï¼‰ |
| Raft | æ˜“ç†è§£ | ä¸­ | å¼ºä¸€è‡´ | etcd, Consul |
| Gossip | ç®€å• | é«˜ | æœ€ç»ˆä¸€è‡´ | Cassandra |
| Zab | ä¸­ç­‰ | é«˜ | å¼ºä¸€è‡´ | ZooKeeper |

**Raft vs Paxos**ï¼š
- Raftï¼šæ˜ç¡®Leaderè§’è‰²ï¼Œæ—¥å¿—æœ‰åºï¼Œæ˜“äºå®ç°
- Paxosï¼šæ— å›ºå®šLeaderï¼Œä¹±åºæäº¤ï¼Œç†è®ºä¼˜é›…ä½†å·¥ç¨‹å¤æ‚

### 2. C++11å…³é”®ç‰¹æ€§
```cpp
// 1. æ™ºèƒ½æŒ‡é’ˆï¼ˆRAIIï¼‰
unique_ptr<Connection> conn = make_unique<Connection>();
shared_ptr<Buffer> buf = make_shared<Buffer>();

// 2. ç§»åŠ¨è¯­ä¹‰ï¼ˆé¿å…æ‹·è´ï¼‰
vector<int> get_data() {
    vector<int> data(1000000);
    return data;  // è¿”å›æ—¶ç§»åŠ¨ï¼Œä¸æ‹·è´
}

// 3. Lambdaè¡¨è¾¾å¼
thread t([&]() {
    while (running) flush_buffer();
});

// 4. æ¡ä»¶å˜é‡
unique_lock<mutex> lock(mtx);
cond.wait(lock, []{ return buffer_ready; });
```

### 3. Linuxæ€§èƒ½è°ƒä¼˜å‘½ä»¤
```bash
# æŸ¥çœ‹ç½‘ç»œè¿æ¥çŠ¶æ€
netstat -antp | grep ESTABLISHED | wc -l

# ç›‘æ§ç£ç›˜I/O
iostat -x 1  # å…³æ³¨ %utilï¼ˆç£ç›˜åˆ©ç”¨ç‡ï¼‰

# æŸ¥çœ‹TCPé‡ä¼ 
netstat -s | grep retransmit

# ç«ç„°å›¾å®šä½CPUçƒ­ç‚¹
perf record -F 99 -p PID -g -- sleep 60
perf script | ./flamegraph.pl > flame.svg
```

---

## âš¡ 15åˆ†é’Ÿå¿«é€Ÿå¤ä¹ æ¸…å•

### å¿…èƒŒæ ¸å¿ƒç‚¹ï¼ˆé¢è¯•å‰10åˆ†é’Ÿçœ‹ï¼‰

**æ–‡ä»¶æœåŠ¡ç³»ç»Ÿ**ï¼š
- [ ] åŒç¼“å†²åŸç†ï¼ˆä¸€å¥è¯ï¼‰ï¼šAç¼“å†²å†™å…¥ï¼ŒBç¼“å†²åˆ·æ–°ï¼Œäº¤æ¢æŒ‡é’ˆ
- [ ] ETæ¨¡å¼ç‰¹ç‚¹ï¼šçŠ¶æ€æ”¹å˜æ—¶æ‰é€šçŸ¥ï¼Œéœ€whileè¯»åˆ°EAGAIN
- [ ] sendfileä¼˜åŠ¿ï¼šå†…æ ¸ç›´æ¥ä¼ è¾“ï¼Œé¿å…ç”¨æˆ·æ€æ‹·è´
- [ ] LRU-Ké€‰æ‹©ï¼šK=2å¹³è¡¡å‘½ä¸­ç‡å’Œå†…å­˜å¼€é”€
- [ ] æ€§èƒ½æ•°æ®ï¼šQPS 8.5kï¼ŒP99å»¶è¿Ÿ5msï¼Œå³°å€¼åå130MB/s

**Raftç³»ç»Ÿ**ï¼š
- [ ] é€‰ä¸¾æµç¨‹ï¼šå¿ƒè·³è¶…æ—¶â†’Candidateâ†’å‘é€RequestVoteâ†’è·å¾—å¤šæ•°ç¥¨â†’Leader
- [ ] æ—¥å¿—å¤åˆ¶ï¼šLeaderè¿½åŠ â†’å¹¶è¡Œå¤åˆ¶â†’å¤šæ•°æŒä¹…åŒ–â†’æäº¤â†’åº”ç”¨çŠ¶æ€æœº
- [ ] å®‰å…¨æ€§ï¼šTermå•è°ƒé€’å¢+å¤šæ•°æ´¾+é€‰ä¸¾é™åˆ¶â†’ä¸ä¼šåŒä¸»
- [ ] è·³è¡¨ä¼˜åŠ¿ï¼šå®ç°ç®€å•ï¼Œæ”¯æŒæ— é”å¹¶å‘è¯»ï¼ŒO(logN)æŸ¥è¯¢
- [ ] æ€§èƒ½æ•°æ®ï¼š12k QPSï¼ŒP99å»¶è¿Ÿ1.5msï¼Œæ”¯æŒ10Mé”®å€¼å¯¹

**é€šç”¨**ï¼š
- [ ] é‡åˆ°ä¸ä¼šçš„é—®é¢˜ï¼šæ‰¿è®¤ä¸è¶³â†’å±•ç°æ€è·¯â†’è¯·æ•™å­¦ä¹ 
- [ ] é¡¹ç›®æ˜¯è·Ÿæ•™ç¨‹ï¼Ÿæ‰¿è®¤å‚è€ƒâ†’å¼ºè°ƒåˆ›æ–°â†’è¯æ˜æ·±åº¦ç†è§£
- [ ] STARæ³•åˆ™ï¼šèƒŒæ™¯â†’ä»»åŠ¡â†’è¡ŒåŠ¨â†’ç»“æœ

---

## ğŸ“ é«˜çº§åŠ åˆ†é¡¹ï¼ˆæœ‰ä½™åŠ›å‡†å¤‡ï¼‰

### 1. æ€§èƒ½ä¼˜åŒ–ç»éªŒæ€»ç»“
```
æˆ‘çš„ä¼˜åŒ–æ–¹æ³•è®ºåˆ†3ä¸ªå±‚æ¬¡ï¼š

1. ç®—æ³•å±‚ï¼š
   - åŒç¼“å†²å‡å°‘é”ç«äº‰
   - æ‰¹é‡å¤„ç†å‡å°‘ç³»ç»Ÿè°ƒç”¨
   - LRU-Ké™ä½ç¼“å­˜missç‡

2. ç³»ç»Ÿå±‚ï¼š
   - ETæ¨¡å¼å‡å°‘epoll_waitæ¬¡æ•°
   - sendfileå‡å°‘æ‹·è´
   - mmapæ˜ å°„æ–‡ä»¶å‡å°‘read/write

3. å·¥å…·å±‚ï¼š
   - jemallocä¼˜åŒ–å†…å­˜åˆ†é…
   - perfå®šä½CPUçƒ­ç‚¹
   - wrkå‹æµ‹æ‰¾åˆ°ç“¶é¢ˆ
```

### 2. åˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡åŸåˆ™
```
1. å®¹é”™æ€§ï¼šå‡è®¾èŠ‚ç‚¹ä¼šå®•æœºï¼Œè®¾è®¡å†—ä½™ï¼ˆRaft N/2å®¹é”™ï¼‰
2. å¯è§‚æµ‹æ€§ï¼šæš´éœ²å…³é”®æŒ‡æ ‡ï¼ˆQPSã€å»¶è¿Ÿã€é”™è¯¯ç‡ï¼‰
3. å‘åå…¼å®¹ï¼šåè®®ç‰ˆæœ¬å·ï¼Œæ”¯æŒå¹³æ»‘å‡çº§
4. æµ‹è¯•é©±åŠ¨ï¼šJepsenéªŒè¯ä¸€è‡´æ€§ï¼Œæ··æ²Œå·¥ç¨‹æ³¨å…¥æ•…éšœ
```

### 3. ç”Ÿäº§çº§éœ€è¦è¡¥å……çš„åŠŸèƒ½
```
å½“å‰æ˜¯MVPç‰ˆæœ¬ï¼Œè¦ä¸Šç”Ÿäº§è¿˜éœ€è¦ï¼š

1. ç›‘æ§å‘Šè­¦ï¼šé›†æˆPrometheus + Grafana
2. é…ç½®ç®¡ç†ï¼šæ”¯æŒåŠ¨æ€ä¿®æ”¹æ—¥å¿—çº§åˆ«ï¼ˆæ— éœ€é‡å¯ï¼‰
3. ç°åº¦å‘å¸ƒï¼šæµé‡é€æ­¥åˆ‡æ¢åˆ°æ–°ç‰ˆæœ¬
4. é™æµé™çº§ï¼šé˜²æ­¢é›ªå´©ï¼ˆä»¤ç‰Œæ¡¶ç®—æ³•ï¼‰
5. å®‰å…¨åŠ å›ºï¼šTLSåŠ å¯†é€šä¿¡ï¼Œè¯·æ±‚ç­¾åé˜²ä¼ªé€ 
```

---

## ğŸš€ é¢è¯•å‰1å°æ—¶å¤ä¹ è®¡åˆ’

**40åˆ†é’Ÿ**ï¼šè¿‡ä¸€éæœ¬æ–‡æ¡£ï¼Œé‡ç‚¹çœ‹"æ ¸å¿ƒåŸç†é€Ÿè®°"å’Œ"é«˜é¢‘å‹åŠ›é—®é¢˜"

**15åˆ†é’Ÿ**ï¼šåœ¨çº¸ä¸Šé»˜å†™åŒç¼“å†²ä»£ç å’ŒRafté€‰ä¸¾æµç¨‹

**5åˆ†é’Ÿ**ï¼šå‡†å¤‡3ä¸ªä½ æƒ³é—®é¢è¯•å®˜çš„é—®é¢˜ï¼ˆæ˜¾ç¤ºä½ çš„æ€è€ƒæ·±åº¦ï¼‰ï¼š
```
1. "è´µå¸çš„XXç³»ç»Ÿç”¨çš„æ˜¯ä»€ä¹ˆå…±è¯†ç®—æ³•ï¼Ÿé€‰å‹æ—¶æ€ä¹ˆè€ƒè™‘çš„ï¼Ÿ"
2. "ä½ ä»¬çš„æ—¥å¿—ç³»ç»Ÿæ˜¯è‡ªç ”è¿˜æ˜¯ç”¨å¼€æºæ–¹æ¡ˆï¼ˆå¦‚spdlogï¼‰ï¼Ÿ"
3. "å›¢é˜Ÿæ›´çœ‹é‡å€™é€‰äººçš„å“ªäº›èƒ½åŠ›ï¼Ÿæˆ‘åœ¨å“ªäº›æ–¹é¢è¿˜éœ€è¦åŠ å¼ºï¼Ÿ"
```

---

## ğŸ­ å‹åŠ›é¢è¯•å¿ƒç†å‡†å¤‡ä¸åº”å¯¹ç­–ç•¥

### è¯†åˆ«å‹åŠ›é¢è¯•å¸¸è§å¥—è·¯

#### å¥—è·¯1ï¼šè¿ç»­è¿½é—®ç»†èŠ‚ï¼ˆå‹åŠ›æµ‹è¯•ï¼‰
```
é¢è¯•å®˜ï¼š"ä½ è¯´ç”¨äº†epoll ETæ¨¡å¼ï¼Ÿ"
ä½ ï¼š"æ˜¯çš„"
é¢è¯•å®˜ï¼š"ä¸ºä»€ä¹ˆä¸ç”¨LTï¼Ÿ"
ä½ ï¼š"ETæ›´é«˜æ•ˆ..."
é¢è¯•å®˜ï¼š"é«˜æ•ˆåœ¨å“ªï¼Ÿå…·ä½“æ•°æ®å‘¢ï¼Ÿ"
ä½ ï¼š"å‡å°‘ç³»ç»Ÿè°ƒç”¨..."
é¢è¯•å®˜ï¼š"å‡å°‘äº†å¤šå°‘ï¼Ÿæµ‹è¯•è¿‡å—ï¼Ÿ"
ä½ ï¼š"ä»15ké™åˆ°4.2k..."
é¢è¯•å®˜ï¼š"ä¸ºä»€ä¹ˆæ˜¯è¿™ä¸ªæ¯”ä¾‹ï¼Ÿå’Œä½ çš„ä¸šåŠ¡åœºæ™¯æœ‰å…³ç³»å—ï¼Ÿ"
```

**åº”å¯¹ç­–ç•¥**ï¼š
1. **ä¸è¦æ…Œ**ï¼šè¿™æ˜¯åœ¨æµ‹è¯•ä½ çš„æ·±åº¦ç†è§£ï¼Œä¸æ˜¯æŒ‘æˆ˜ä½ 
2. **æ‰¿è®¤è¾¹ç•Œ**ï¼š"è¿™ä¸ªæ¯”ä¾‹æ˜¯åœ¨æˆ‘çš„æµ‹è¯•åœºæ™¯ä¸‹ï¼Œä¸åŒåœºæ™¯ä¼šæœ‰å·®å¼‚"
3. **å±•ç°æ€è€ƒ**ï¼š"æˆ‘åˆ†æå¯èƒ½æ˜¯å› ä¸º...ï¼Œå¦‚æœæœ‰æœºä¼šæˆ‘æƒ³è¿›ä¸€æ­¥ç ”ç©¶..."

#### å¥—è·¯2ï¼šè´¨ç–‘é¡¹ç›®çœŸå®æ€§
```
é¢è¯•å®˜ï¼š"è¿™ä¸ªé¡¹ç›®çœ‹èµ·æ¥å’ŒXXXè¯¾ç¨‹å¾ˆåƒå•Šï¼Ÿ"
é¢è¯•å®˜ï¼š"ä½ çš„QPSæ‰8.5kï¼Œæ¯”å¼€æºé¡¹ç›®å·®è¿œäº†å§ï¼Ÿ"
é¢è¯•å®˜ï¼š"è¿™äº›æ•°æ®æ˜¯ä½ è‡ªå·±æµ‹çš„è¿˜æ˜¯ç¼–çš„ï¼Ÿ"
```

**åº”å¯¹ç­–ç•¥**ï¼ˆSTARåå‡»ï¼‰ï¼š
```
"ç¡®å®å‚è€ƒäº†XXXè¯¾ç¨‹ï¼Œä½†æˆ‘åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢åšäº†æ”¹è¿›ï¼š
1. ã€Situationã€‘åŸç‰ˆæ²¡æœ‰æ—¥å¿—å‹ç¼©åŠŸèƒ½
2. ã€Taskã€‘æˆ‘éœ€è¦åœ¨ç”Ÿäº§ç¯å¢ƒæ§åˆ¶ç£ç›˜å ç”¨
3. ã€Actionã€‘ç ”ç©¶äº†gzipå’Œzlibï¼Œæœ€ç»ˆé€‰æ‹©zlib level 5å¹³è¡¡å‹ç¼©ç‡å’ŒCPU
4. ã€Resultã€‘å‹ç¼©ç‡è¾¾åˆ°70%ï¼ŒCPUå ç”¨ä»…å¢åŠ 5%

å…³äºæ€§èƒ½æ•°æ®ï¼Œæˆ‘æ˜¯è¿™æ ·æµ‹è¯•çš„ï¼š
- ä½¿ç”¨wrkå‹æµ‹å·¥å…·ï¼Œè¿™æ˜¯è„šæœ¬ï¼ˆå±•ç¤ºå…·ä½“å‘½ä»¤ï¼‰
- åœ¨é˜¿é‡Œäº‘2æ ¸4Gç¯å¢ƒï¼Œè¿™æ˜¯é…ç½®æˆªå›¾
- æµ‹è¯•ç»“æœåœ¨è¿™é‡Œï¼ˆå¦‚æœæœ‰ï¼Œå±•ç¤ºwrkè¾“å‡ºï¼‰
```

#### å¥—è·¯3ï¼šè®¾ç½®ä¸å¯èƒ½å®Œæˆçš„ä»»åŠ¡
```
é¢è¯•å®˜ï¼š"å¦‚æœè®©ä½ æŠŠQPSä»8.5kæå‡åˆ°100kï¼Œæ€ä¹ˆåšï¼Ÿ"
é¢è¯•å®˜ï¼š"ç»™ä½ 2å‘¨æ—¶é—´å®ç°ä¸€ä¸ªå®Œæ•´çš„åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œå¯ä»¥å—ï¼Ÿ"
```

**åº”å¯¹ç­–ç•¥**ï¼ˆå±•ç°ç³»ç»Ÿæ€ç»´ï¼‰ï¼š
```
"è¿™æ˜¯ä¸€ä¸ªå¾ˆæœ‰æŒ‘æˆ˜çš„ç›®æ ‡ï¼Œæˆ‘ä¼šè¿™æ ·æ‹†è§£ï¼š

çŸ­æœŸï¼ˆ1ä¸ªæœˆå†…ï¼Œ10k â†’ 30kï¼‰ï¼š
1. ä¼˜åŒ–çƒ­ç‚¹ï¼šç«ç„°å›¾å®šä½CPUç“¶é¢ˆ
2. å¼•å…¥io_uringæ›¿ä»£epollï¼ˆæ€§èƒ½æå‡20-40%ï¼‰
3. å®ç°é›¶æ‹·è´ï¼šsendfile + splice

ä¸­æœŸï¼ˆ3ä¸ªæœˆå†…ï¼Œ30k â†’ 60kï¼‰ï¼š
1. æ°´å¹³æ‰©å±•ï¼šè´Ÿè½½å‡è¡¡+å¤šå®ä¾‹
2. ç¼“å­˜ä¼˜åŒ–ï¼šRediså‰ç½®ç¼“å­˜
3. å¼‚æ­¥åŒ–ï¼šè¯·æ±‚æ’é˜Ÿ+æ‰¹å¤„ç†

é•¿æœŸï¼ˆ100kç›®æ ‡ï¼‰ï¼š
è¿™éœ€è¦æ¶æ„çº§åˆ«çš„æ”¹é€ ï¼Œå•æœºç“¶é¢ˆåœ¨æ­¤ã€‚å¯èƒ½éœ€è¦ï¼š
- åˆ†å¸ƒå¼æ¶æ„ï¼ˆæœåŠ¡æ‹†åˆ†ï¼‰
- DPDKç”¨æˆ·æ€ç½‘ç»œæ ˆï¼ˆç»•è¿‡å†…æ ¸ï¼‰
- RDMAé›¶æ‹·è´ç½‘ç»œ

å¦‚æœæ—¶é—´å’Œèµ„æºæœ‰é™ï¼Œæˆ‘ä¼šä¼˜å…ˆåšçŸ­æœŸä¼˜åŒ–ï¼Œæ€§ä»·æ¯”æœ€é«˜ã€‚"
```

### å›ç­”æŠ€å·§æ€»ç»“

#### 1. é»„é‡‘ä¸‰è§’ï¼šåŸç† â†’ å®ç° â†’ æ•°æ®
```
é¢è¯•å®˜ï¼š"ä½ çš„å¼‚æ­¥æ—¥å¿—æ€ä¹ˆå®ç°çš„ï¼Ÿ"

âŒ å·®çš„å›ç­”ï¼š"ç”¨äº†åŒç¼“å†²"

âœ… å¥½çš„å›ç­”ï¼š
"ã€åŸç†ã€‘é‡‡ç”¨åŒç¼“å†²+ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ï¼Œè§£è€¦æ—¥å¿—å†™å…¥å’Œç£ç›˜åˆ·æ–°
 ã€å®ç°ã€‘å‰ç«¯çº¿ç¨‹å†™å…¥BufferAï¼Œåç«¯çº¿ç¨‹åˆ·æ–°BufferBï¼Œé€šè¿‡æ¡ä»¶å˜é‡é€šçŸ¥äº¤æ¢
 ã€æ•°æ®ã€‘æ‰¹é‡å†™å…¥å°†I/Oå»¶è¿Ÿä»15msé™è‡³2.3msï¼ŒIOPSæå‡2.8å€"
```

#### 2. å¯¹æ¯”æ³•ï¼šå‡¸æ˜¾ä½ çš„é€‰æ‹©
```
é¢è¯•å®˜ï¼š"ä¸ºä»€ä¹ˆç”¨è·³è¡¨ä¸ç”¨çº¢é»‘æ ‘ï¼Ÿ"

âœ… å¥½çš„å›ç­”ï¼ˆå¯¹æ¯”è¡¨æ ¼ï¼‰ï¼š
"æˆ‘å¯¹æ¯”äº†ä¸‰ç§æ–¹æ¡ˆï¼š
| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | æ˜¯å¦é€‰æ‹© |
|-----|------|-----|----------|
| çº¢é»‘æ ‘ | æ ‡å‡†åº“ç°æˆ | å¹¶å‘éœ€è¦å…¨å±€é” | âŒ |
| B+æ ‘ | ç¼“å­˜å‹å¥½ | å†…å­˜æ•°æ®åº“ä¼˜åŠ¿ä¸æ˜æ˜¾ | âŒ |
| è·³è¡¨ | æ— é”å¹¶å‘è¯»ï¼Œå®ç°ç®€å• | ç©ºé—´å¼€é”€ç¨å¤§ | âœ… |

æœ€ç»ˆé€‰è·³è¡¨æ˜¯æƒè¡¡äº†å¹¶å‘æ€§èƒ½å’Œå®ç°å¤æ‚åº¦ã€‚"
```

#### 3. è¯šå® + æ€è€ƒï¼šä¸ä¼šä¹Ÿèƒ½å¾—åˆ†
```
é¢è¯•å®˜ï¼š"å¦‚æœå®ç°è·¨æ•°æ®ä¸­å¿ƒçš„Raftï¼Ÿ"

âŒ å·®ï¼š"è¿™ä¸ªæˆ‘ä¸çŸ¥é“"

âœ… å¥½ï¼š
"æˆ‘æ²¡æœ‰å®é™…ç»éªŒï¼Œä½†æˆ‘åˆ†æä¸»è¦æŒ‘æˆ˜åœ¨ï¼š
1. ç½‘ç»œå»¶è¿Ÿï¼šè·¨æœºæˆ¿RTTä»1ms â†’ 50msï¼Œéœ€è¦è°ƒæ•´è¶…æ—¶å‚æ•°
2. å¯ç”¨æ€§ï¼šå¤šæ•°æ´¾è¦æ±‚å¯¼è‡´è·¨æœºæˆ¿å†™å…¥å»¶è¿Ÿé«˜
3. ä¸€è‡´æ€§ï¼šç½‘ç»œåˆ†åŒºæ¦‚ç‡å¢åŠ 

æˆ‘æŸ¥é˜…è¿‡ä¸€äº›èµ„æ–™ï¼Œå¯èƒ½çš„æ–¹æ¡ˆæœ‰ï¼š
- Raftå˜ç§ï¼šå¤šæ•°æ´¾é™çº§ä¸ºæœ¬åœ°æœºæˆ¿ï¼ˆç‰ºç‰²ä¸€è‡´æ€§æ¢å¯ç”¨æ€§ï¼‰
- åˆ†å±‚æ¶æ„ï¼šæœºæˆ¿å†…Raft + è·¨æœºæˆ¿å¼‚æ­¥å¤åˆ¶
- å¼•å…¥è§è¯èŠ‚ç‚¹ï¼šè½»é‡çº§æŠ•ç¥¨èŠ‚ç‚¹é™ä½å»¶è¿Ÿ

ä¸çŸ¥é“ç”Ÿäº§å®è·µä¸­ç”¨å“ªç§æ–¹æ¡ˆæ¯”è¾ƒå¤šï¼Ÿ"
```

### å±æœºå¤„ç†

#### åœºæ™¯1ï¼šè¢«é—®å€’äº†ï¼Œå¤§è„‘ç©ºç™½
```
æ·±å‘¼å¸ 3ç§’ â†’ "è¿™ä¸ªé—®é¢˜å¾ˆæœ‰æ„æ€ï¼Œè®©æˆ‘æ•´ç†ä¸€ä¸‹æ€è·¯..."

äº‰å–æ—¶é—´çš„è¯æœ¯ï¼š
- "èƒ½å¦ä¸¾ä¸ªå…·ä½“åœºæ™¯ï¼Ÿè¿™æ ·æˆ‘èƒ½æ›´å‡†ç¡®åœ°å›ç­”"
- "è¿™ä¸ªé—®é¢˜æ¶‰åŠé¢æ¯”è¾ƒå¹¿ï¼Œæ‚¨æ˜¯æƒ³äº†è§£XXæ–¹é¢è¿˜æ˜¯YYæ–¹é¢ï¼Ÿ"
- "æˆ‘å…ˆè¯´è¯´æˆ‘çš„ç†è§£ï¼Œå¦‚æœæœ‰åå·®è¯·æŒ‡æ­£"
```

#### åœºæ™¯2ï¼šå®ç°ç»†èŠ‚è®°ä¸æ¸…äº†
```
è¯šå® + è¡¥æ•‘ï¼š
"å…·ä½“çš„å‚æ•°æˆ‘è®°ä¸å¤ªæ¸…äº†ï¼ˆè¯šå®ï¼‰
ä½†æˆ‘è®°å¾—å½“æ—¶çš„å†³ç­–é€»è¾‘æ˜¯...ï¼ˆå±•ç°æ€è€ƒè¿‡ç¨‹ï¼‰
å¦‚æœæ‚¨æ„Ÿå…´è¶£ï¼Œæˆ‘å¯ä»¥ä¼šåæŸ¥ä»£ç ç¡®è®¤å‡†ç¡®å€¼ï¼ˆè¡¥æ•‘ï¼‰"

ç¤ºä¾‹ï¼š
"å¿ƒè·³é—´éš”å…·ä½“æ˜¯50msè¿˜æ˜¯60msæˆ‘è®°ä¸æ¸…äº†ï¼Œä½†æˆ‘è®°å¾—è®¾è®¡åŸåˆ™æ˜¯ï¼š
ç¡®ä¿åœ¨è¶…æ—¶æ—¶é—´ï¼ˆ150msï¼‰å†…èƒ½å‘é€è‡³å°‘2æ¬¡å¿ƒè·³ï¼Œå®¹å¿1æ¬¡ä¸¢åŒ…ã€‚
æ‰€ä»¥è®¡ç®—å…¬å¼æ˜¯ï¼š150ms / 3 â‰ˆ 50ms"
```

#### åœºæ™¯3ï¼šé¢è¯•å®˜æŒ‡å‡ºä½ çš„é”™è¯¯
```
âŒ å·®ï¼šè¾©è§£ "ä¸æ˜¯è¿™æ ·çš„ï¼Œæˆ‘æ˜¯å¯¹çš„..."

âœ… å¥½ï¼šè™šå¿ƒ + å­¦ä¹ 
"æ„Ÿè°¢æŒ‡æ­£ï¼æˆ‘ç¡®å®ç†è§£æœ‰åå·®ï¼ˆæ‰¿è®¤é”™è¯¯ï¼‰
æ‚¨è¯´çš„è¿™ä¸ªç‚¹ä¹‹å‰æ²¡è€ƒè™‘åˆ°ï¼ˆè™šå¿ƒï¼‰
èƒ½å±•å¼€è®²è®²å—ï¼Ÿæˆ‘å¾ˆæƒ³å­¦ä¹ ï¼ˆå­¦ä¹ æ€åº¦ï¼‰"

æ³¨æ„ï¼šå¦‚æœä½ ç¡®ä¿¡è‡ªå·±æ˜¯å¯¹çš„ï¼Œå¯ä»¥ç¤¼è²Œè®¨è®ºï¼š
"æˆ‘ç†è§£æ‚¨çš„è§‚ç‚¹ï¼Œä¸è¿‡æˆ‘çœ‹åˆ°XXXæ–‡æ¡£/è®ºæ–‡ä¸­æåˆ°...
å¯èƒ½æ˜¯æˆ‘ç†è§£æœ‰è¯¯ï¼Œèƒ½å¸®æˆ‘è§£é‡Šä¸€ä¸‹å·®å¼‚å—ï¼Ÿ"
```

### è‚¢ä½“è¯­è¨€ä¸å¿ƒæ€

#### èº«ä½“å§¿æ€
- âœ… åç›´ï¼Œèº«ä½“å¾®å¾®å‰å€¾ï¼ˆè¡¨ç¤ºä¸“æ³¨ï¼‰
- âœ… é€‚å½“çš„æ‰‹åŠ¿è¾…åŠ©è¡¨è¾¾ï¼ˆå¢å¼ºè¯´æœåŠ›ï¼‰
- âœ… çœ¼ç¥æ¥è§¦ï¼ˆå»ºç«‹ä¿¡ä»»ï¼‰
- âŒ æŠ–è…¿ã€è½¬ç¬”ï¼ˆæ˜¾ç¤ºç´§å¼ ï¼‰
- âŒ åŒæ‰‹æŠ±èƒ¸ï¼ˆé˜²å¾¡å§¿æ€ï¼‰

#### è¯´è¯èŠ‚å¥
- æ”¾æ…¢è¯­é€Ÿï¼šç´§å¼ æ—¶å®¹æ˜“è¶Šè¯´è¶Šå¿«
- é€‚å½“åœé¡¿ï¼šç»™é¢è¯•å®˜æ€è€ƒæ—¶é—´ï¼Œä¹Ÿç»™è‡ªå·±ç¼“å†²
- ç»“æ„åŒ–è¡¨è¾¾ï¼š"é¦–å…ˆ...å…¶æ¬¡...æœ€å..."

#### å¿ƒæ€è°ƒæ•´
```
è®°ä½3ä¸ªäº‹å®ï¼š
1. é¢è¯•å®˜ä¸æ˜¯æ•Œäººï¼Œè€Œæ˜¯æœªæ¥åŒäº‹ï¼ˆåˆä½œå¿ƒæ€ï¼‰
2. ä¸ä¼šçš„é—®é¢˜å¾ˆæ­£å¸¸ï¼Œæ²¡äººå…¨çŸ¥å…¨èƒ½ï¼ˆæ¥å—ä¸å®Œç¾ï¼‰
3. å±•ç°å­¦ä¹ èƒ½åŠ› > èƒŒè¯µæ ‡å‡†ç­”æ¡ˆï¼ˆæˆé•¿æ€§æ€ç»´ï¼‰

å‹åŠ›å¤§æ—¶é»˜å¿µï¼š
"ä»–ä»¬åœ¨è€ƒå¯Ÿæˆ‘çš„æ€è€ƒè¿‡ç¨‹ï¼Œä¸æ˜¯è€ƒè¯•"
"å³ä½¿å¤±è´¥ï¼Œè¿™ä¹Ÿæ˜¯å®è´µçš„å­¦ä¹ ç»éªŒ"
```

---

## ğŸ“Š é¢è¯•å¤ç›˜æ¸…å•

### é¢è¯•åç«‹å³è®°å½•ï¼ˆè®°å¿†æœ€æ¸…æ™°ï¼‰

#### æŠ€æœ¯é—®é¢˜æ¸…å•
```
è¢«é—®åˆ°çš„é—®é¢˜ï¼š
â–¡ _______________________________ï¼ˆè®°å½•é—®é¢˜ï¼‰
  æˆ‘çš„å›ç­”ï¼š___________________ï¼ˆå›ç­”è¦ç‚¹ï¼‰
  é¢è¯•å®˜åé¦ˆï¼š_________________ï¼ˆæ»¡æ„/è¿½é—®/è´¨ç–‘ï¼‰
  æ”¹è¿›ç©ºé—´ï¼š___________________ï¼ˆä¸‹æ¬¡æ€ä¹ˆç­”æ›´å¥½ï¼‰

â–¡ _______________________________
  ...
```

#### æœªè§£å†³çš„ç–‘é—®
```
ä¸ä¼šçš„é—®é¢˜ï¼š
1. _______________________________
   â†’ è®¡åˆ’å­¦ä¹ ï¼šé˜…è¯»XXXæ–‡æ¡£/è®ºæ–‡
   
2. _______________________________
   â†’ è®¡åˆ’å®è·µï¼šå†™demoéªŒè¯
```

#### é¢è¯•å®˜å…³æ³¨ç‚¹
```
è¿™å®¶å…¬å¸çœ‹é‡ï¼š
â–¡ ç®—æ³•èƒ½åŠ›ï¼ˆLeetcodeé£æ ¼ï¼‰
â–¡ ç³»ç»Ÿè®¾è®¡ï¼ˆåˆ†å¸ƒå¼æ¶æ„ï¼‰
â–¡ å·¥ç¨‹èƒ½åŠ›ï¼ˆä»£ç è´¨é‡ã€æµ‹è¯•ï¼‰
â–¡ å­¦ä¹ èƒ½åŠ›ï¼ˆå¦‚ä½•è§£å†³æ–°é—®é¢˜ï¼‰
â–¡ æ²Ÿé€šèƒ½åŠ›ï¼ˆè¡¨è¾¾æ¸…æ™°åº¦ï¼‰

ä¸‹æ¬¡å‡†å¤‡é‡ç‚¹ï¼š___________________
```

### æŒç»­æ”¹è¿›

#### æ¯æ¬¡é¢è¯•åè¡¥å……æ–‡æ¡£
```
æ–°é—®é¢˜æ·»åŠ åˆ°æœ¬æ–‡æ¡£ï¼š
- é«˜é¢‘é—®é¢˜ â†’ æ›´æ–°ç­”æ¡ˆæ¨¡æ¿
- è¾¹ç•Œcase â†’ è¡¥å……åˆ°æŠ€æœ¯ç»†èŠ‚
- æ–°æŠ€æœ¯ç‚¹ â†’ æ‰©å±•çŸ¥è¯†å›¾è°±
```

#### æ¨¡æ‹Ÿç»ƒä¹ 
```
æ‰¾åŒå­¦/æœ‹å‹æ¨¡æ‹Ÿé¢è¯•ï¼š
1. ç»™ä»–ä»¬çœ‹ä½ çš„ç®€å†
2. è®©ä»–ä»¬æ‰®æ¼”é¢è¯•å®˜æé—®ï¼ˆè¶Šåˆé’»è¶Šå¥½ï¼‰
3. å½•éŸ³/å½•å±å¤ç›˜
4. åˆ†æï¼šå“ªé‡Œç­”å¾—å¥½ï¼Ÿå“ªé‡Œå¡å£³ï¼Ÿ
```

---

## ğŸ¯ æœ€åçš„å®å˜±

### é¢è¯•å‰ä¸€æ™š
- âœ… æ—©ç¡ï¼ˆè„‘å­æ¸…é†’æ¯”å¤šèƒŒ1å°æ—¶æœ‰ç”¨ï¼‰
- âœ… å‡†å¤‡å¥½ï¼šç¬”è®°æœ¬ã€å……ç”µå™¨ã€ç®€å†çº¸è´¨ç‰ˆ
- âœ… è®¾ç½®3ä¸ªé—¹é’Ÿï¼ˆé˜²æ­¢è¿Ÿåˆ°ï¼‰
- âŒ ç†¬å¤œåˆ·é¢˜ï¼ˆçŠ¶æ€ä¸å¥½é€‚å¾—å…¶åï¼‰

### é¢è¯•å½“å¤©
- âœ… æå‰15åˆ†é’Ÿåˆ°ï¼ˆç•™ç¼“å†²æ—¶é—´ï¼‰
- âœ… ä¸Šå•æ‰€ï¼ˆé¿å…é¢è¯•ä¸­é€”å°´å°¬ï¼‰
- âœ… å¸¦ç“¶æ°´ï¼ˆè¯´è¯å£æ¸´æ—¶å–ä¸€å£ï¼Œä¹Ÿèƒ½äº‰å–æ€è€ƒæ—¶é—´ï¼‰

### é¢è¯•ç»“æŸæ—¶
```
ç¤¼è²Œè¯¢é—®ï¼š
"è¯·é—®æ‚¨å¯¹æˆ‘çš„è¡¨ç°æœ‰ä»€ä¹ˆå»ºè®®å—ï¼Ÿ"
ï¼ˆå³ä½¿ä¸è¿‡ï¼Œä¹Ÿèƒ½å­¦åˆ°ä¸œè¥¿ï¼‰

"å¤§æ¦‚ä»€ä¹ˆæ—¶å€™èƒ½æ”¶åˆ°åé¦ˆå‘¢ï¼Ÿ"
ï¼ˆè¡¨ç¤ºé‡è§†è¿™ä¸ªæœºä¼šï¼‰

"æ„Ÿè°¢æ‚¨çš„æ—¶é—´ï¼ŒæœŸå¾…ä¸‹æ¬¡äº¤æµï¼"
ï¼ˆç•™ä¸‹å¥½å°è±¡ï¼‰
```

---

**ç¥é¢è¯•é¡ºåˆ©ï¼è®°ä½ï¼š**
1. **è‡ªä¿¡æºäºå‡†å¤‡å……åˆ†** - ä½ å·²ç»æŒæ¡äº†æ ¸å¿ƒçŸ¥è¯†
2. **è¯šå®èƒœè¿‡ä¼ªè£…** - ä¸æ‡‚è£…æ‡‚ä¼šè¢«ä¸€çœ¼çœ‹ç©¿
3. **æ€è€ƒè¿‡ç¨‹æ¯”ç­”æ¡ˆé‡è¦** - å±•ç°ä½ çš„problem-solvingèƒ½åŠ›
4. **æ¯æ¬¡é¢è¯•éƒ½æ˜¯å­¦ä¹ æœºä¼š** - ä¸è¦æ€•å¤±è´¥ï¼Œæ¯æ¬¡éƒ½åœ¨è¿›æ­¥

**ä½ å‡†å¤‡å¥½äº†ï¼å»å±•ç°ä½ çš„å®åŠ›å§ï¼** ğŸš€ğŸ’ª

---

*æœ¬æ–‡æ¡£æŒç»­æ›´æ–°ä¸­ï¼Œæ¬¢è¿è¡¥å……æ–°çš„é¢è¯•é¢˜å’Œåº”å¯¹ç­–ç•¥*

